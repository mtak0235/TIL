ì§€ê¸ˆê¹Œì§€ ë§Œë“  DAO ì— transaction ì„ ì ìš©í•˜ë©´ì„œ ìŠ¤í”„ë§ì´ ì–´ë–»ê²Œ ì„±ê²©ì´ ë¹„ìŠ·í•œ ì—¬ëŸ¬ ì¢…ë¥˜ì˜ ê¸°ìˆ ì„ ì¶”ìƒí™”í•˜ê³  ì´ë¥¼ ì¼ê´€ëœ ë°©ë²•ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì§€ì›í•˜ëŠ”ì§€ë¥¼ ì‚´í´ë³´ì.  

# 1. ì‚¬ìš©ì ë ˆë²¨ ê´€ë¦¬ ê¸°ëŠ¥ ì¶”ê°€

í˜„ì¬ UserDaoëŠ” CRUDë§Œ ê°€ëŠ¥í•˜ë‹¤. ì—¬ê¸°ì— ì‚¬ìš©ì ê´€ë¦¬ ê¸°ëŠ¥ì„ ì¶”ê°€í•´ë³´ì
ë§Œë“¤ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§

* ì‚¬ìš©ìì˜ ë ˆë²¨ì€ BASIC, SILVER, GOLD ì„¸ ê°€ì§€ ì¤‘ í•˜ë‚˜ë‹¤.
*  ì‚¬ìš©ìê°€ ì²˜ìŒ ê°€ì…í•˜ë©´ BASIC ë ˆë²¨ì´ ë˜ë©°, ì´í›„ í™œë™ì— ë”°ë¼ì„œ í•œ ë‹¨ê³„ì”© ì—…ê·¸ë ˆì´ë“œë  ìˆ˜  ìˆë‹¤. 
* ê°€ì… í›„ 50íšŒ ì´ìƒ ë¡œê·¸ì¸ì„ í•˜ë©´ BASICì—ì„œ SILVER ë ˆë²¨ì´ ëœë‹¤. 
* SILVER ë ˆë²¨ì´ë©´ì„œ 30ë²ˆ ì´ìƒ ì¶”ì²œì„ ë°›ìœ¼ë©´ GOLD ë ˆë²¨ì´ ëœë‹¤. 
* ì‚¬ìš©ì ë ˆë²¨ì˜ ë³€ê²½ ì‘ì—…ì€ ì¼ì •í•œ ì£¼ê¸°ë¥¼ ê°€ì§€ê³  ì¼ê´„ì ìœ¼ë¡œ ì§„í–‰ëœë‹¤
  ë³€ê²½ ì‘ì—… ì „ì—ëŠ” ì¡° ê±´ì„ ì¶©ì¡±í•˜ë”ë¼ë„ ë ˆë²¨ì˜ ë³€ê²½ì´ ì¼ì–´ë‚˜ì§€ ì•ŠëŠ”ë‹¤

ğŸ˜ì¡°ê±´ì— ë”°ë¼ ì‚¬ìš©ìì˜ ë ˆë²¨ì„ ì£¼ê¸°ì ìœ¼ë¡œ ë³€ê²½í•œë‹¤ëŠ” ë‚´ìš©ì´ë¡œêµ°

## 1.1 í•„ë“œ ì¶”ê°€

### Level enum

User classì— ì‚¬ìš©ìì˜ ë ˆë²¨ì„ ì €ì¥í•  í•„ë“œë¥¼ ì¶”ê°€í•˜ì . 

ğŸ¤”varchar íƒ€ì…ìœ¼ë¡œ í• ê¹Œ? ë³„ë¡ ë°.. ê° ë ˆë²¨ì„ ì½”ë“œí™” í•´ì„œ ìˆ«ìë¡œ ë„£ì„ê¹Œ?

```java
class User {
private static final int BASIC = 1;
private static final int SILVER = 2;
private static final int GOLD = 3;
int level;
public void setLevel(int level) {
 this.level = level;
}
```

```java
if (user1.getLevel() = = User.BASIC) {
user1.setLevel(User.SILVER);
}
```

ğŸ¤”levelì˜ íƒ€ì…ì´ intë¼ì„œ ë‹¤ë¥¸ ì¢…ë¥˜ì˜ ì •ë³´ë¥¼ ë„£ê±°ë‚˜ ì—†ëŠ” ë²ˆí˜¸ë¥¼ ë„£ì–´ë„ ì»´íŒŒì¼ëŸ¬ê°€ ëª¨ë¥¼ ê²ƒ ê°™ë‹¤. 

``` java
user1.setLevel(other.getSum());
user1.setLevel(1000);
```

ğŸ˜java5 ~ ì˜  enumì„ ì‚¬ìš©í•˜ì

```java
package com.example.tobby.user.dao;

public enum Level {
    BASIC(1), SILVER(2), GOLD(3);
    private final int value;

    public int getValue() {
        return value;
    }

    Level(int value) {
        this.value = value;
    }

    public static Level valueOf(int value) {
        return switch (value) {
            case 1 -> BASIC;
            case 2 -> SILVER;
            case 3 -> GOLD;
            default -> throw new AssertionError("Unknown value: " + value);
        };
    }
}

```

### User í•„ë“œ ì¶”ê°€

Level typed ë³€ìˆ˜, ë¡œê·¸ì¸ íšŸìˆ˜, ì¶”ì²œìˆ˜ê¹Œì§€ User classì— ì¶”ê°€í•˜ì. 

### UserDaoTest ìˆ˜ì •

```java
    @BeforeEach
    private void setUp() {
        SingleConnectionDataSource dataSource = new SingleConnectionDataSource("jdbc:mysql://localhost/tobby", "tobaby", "0000", true);
//        dao.setDataSource(dataSource);
//        dao = context.getBean("userDao", UserDao.class);
        user3 = new User("mtak", "íƒë¯¼ê²½", "0000", Level.BASIC, 1, 0);
        user1 = new User("yeji", "íƒì˜ˆì§€", "0000", Level.SILVER, 55, 10);
        user2 = new User("doyun", "íƒë„ìœ¤", "000", Level.GOLD, 100, 40);
        
    }

```

â€‹	

```java
    private void checkSameUser(User user, User user1) {
        assertThat(user.getId()).isEqualTo(user1.getId());
        assertThat(user.getPassword()).isEqualTo(user1.getPassword());
        assertThat(user.getName()).isEqualTo(user1.getName());
        assertThat(user.getLevel()).isEqualTo(user1.getLevel());
        assertThat(user.getLogin()).isEqualTo(user1.getLogin());
        assertThat(user.getRecommend()).isEqualTo(user1.getRecommend());
    }
```

###  UserDaoJdbc ìˆ˜ì •

```java
    public void add(User user) {
        this.jdbcTemplate.update("insert into users (id, name, password, level, login, recommend) values(?,?,?, ?, ?, ?)", user.getId(), user.getName(), user.getPassword(), user.getLevel().intValue(), user.getLogin(), user.getRecommend());

    }
```

```java
public class UserDaoJdbc implements UserDao {

    private final RowMapper<User> userMapper = new RowMapper<>() {
        @Override
        public User mapRow(ResultSet rs, int rowNum) throws SQLException {
            User user = new User();
            user.setId(rs.getString("id"));
            user.setName(rs.getString("name"));
            user.setPassword(rs.getString("password"));
            user.setLevel(Level.valueOf(rs.getString("level")));
            user.setLogin(rs.getInt("login"));
            user.setRecommend(rs.getInt("recommend"));
            return user;
        }
    };
    ...
}
```

## 1.2 ì‚¬ìš©ì ìˆ˜ì • ê¸°ëŠ¥ ì¶”ê°€

ìˆ˜ì •í•  ì •ë³´ê°€ ë‹´ê¸´ User ì˜¤ ë¸Œì íŠ¸ë¥¼ ì „ë‹¬í•˜ë©´ idë¥¼ ì°¸ê³ í•´ì„œ ì‚¬ìš©ìë¥¼ ì°¾ì•„ í•„ë“œ ì •ë³´ë¥¼ UPDATE ë¬¸ì„ ì´ìš©í•´ ëª¨ë‘  ë³€ê²½í•´ì£¼ëŠ” ë©”ì†Œë“œë¥¼ í•˜ë‚˜ ë§Œë“¤ê² ë‹¤. 

### ìˆ˜ì • ê°€ëŠ¥ í…ŒìŠ¤íŠ¸ ì¶”ê°€

```java
    @Test
    public void update() {
        dao.deleteAll();
        dao.add(user1);
        user1.setName("ë£¨ì‚¥ë½•");
        user1.setPassword("0000");
        user1.setLevel(Level.GOLD);
        user1.setLogin(1000);
        user1.setRecommend(999);
        dao.update(user1);
        User user1update = dao.get(user1.getId());
        checkSameUser(user1, user1update);
    }
```

### UserDaoì™€ UserDaoJdbc ìˆ˜ì •

```java
@Override
    public void update(User user) {
        this.jdbcTemplate.update("update users set name=?, password=?, level=?, login=?, recomment=? where id=?", user.getName(), user.getPassword(), user.getLevel().intValue(), user.getLogin(), user.getRecommend(), user.getId());
    }
```

### ìˆ˜ì • í…ŒìŠ¤íŠ¸ ë³´ì™„

ë§Œì•½, ì¿¼ë¦¬ì—ì„œ whereë¬¸ì´ ë¹ ì§€ë©´ ì§€ê¸ˆ Testë¬¸ìœ¼ë¡  ëª» ì¡ëŠ”ë‹¤. ìˆ˜ì •í•œ ë ˆì½”ë“œëŠ” ë³€ê²½ì‚¬í•­ì´ ì˜ ë°˜ì˜ ë˜ì—ˆëŠ”ì§€ í™•ì¸ì„ í•˜ëŠ”ë°, ë‹¤ë¥¸ ë ˆì½”ë“œëŠ” ì—¬ì „íˆ ë°”ë€Œì§€ ì•Šì•˜ëŠ”ì§€ í™•ì¸í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì´ë‹¤.  ì–´ì¹´ë…¸?

1. jdbcTemplateì˜ update()ê°€ ëŒë ¤ì£¼ëŠ” ë¦¬í„´ ê°’ì„ í™•ì¸í•œë‹¤. 
   * jdbcTemplateì˜  update()ëŠ” update, deleteê°™ì´ í…Œì´ë¸”ì— ì˜í–¥ì„ ì£¼ëŠ” SQLì„ ì‹¤í–‰í•˜ë©´ì„œ ëª‡ê°œì˜ rowê°€ ì˜í–¥ì„ ë°›ì•˜ëŠ”ì§€ ë¦¬í„´í•œë‹¤. 
2. í…ŒìŠ¤íŠ¸ë¥¼ ë³´ê°•í•´ì„œ ì›í•˜ëŠ” ì‚¬ìš©ì ì™¸ì˜ ì •ë³´ê°€ ê·¸ëŒ€ë¡œê°€ ë§ëŠ”ì§€ í™•ì¸í•œë‹¤. 

## 1.3 UserService.upgradeLevels()

 UserDaoì˜ getAll() ë©”ì†Œë“œë¡œ ì‚¬ìš©ìë¥¼ ë‹¤ ê°€ì ¸ì™€ì„œ ì‚¬ìš© ìë³„ë¡œ ë ˆë²¨ ì—…ê·¸ë ˆì´ë“œ ì‘ì—…ì„ ì§„í–‰í•˜ë©´ì„œ UserDaoì˜ update()ë¥¼ í˜¸ì¶œí•´ DBì— ê²°ê³¼ë¥¼  ë„£ì–´ì£¼ë©´ ëœë‹¤.

### UserService í´ë˜ìŠ¤ì™€ ë¹ˆ ë“±ë¡

```java
package com.example.tobby.user;

import com.example.tobby.user.dao.UserDao;

public class UserService {
    UserDao userDao;

    public void setUserDao(UserDao userDao) {
        this.userDao = userDao;
    }
}

```

```xml
    <bean id="userService" class="com.example.tobby.user.UserService">
        <property name="userDao" ref="userDao"/>
    </bean>
```

### UserServiceTest class

```java
package com.example.tobby.user;

import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.ContextConfiguration;
import org.springframework.test.context.junit.jupiter.SpringExtension;

import static org.assertj.core.api.Assertions.assertThat;
import static org.junit.jupiter.api.Assertions.*;

@SpringBootTest
@ExtendWith(SpringExtension.class)
@ContextConfiguration(locations = "/test.xml")
class UserServiceTest {

    @Autowired
    UserService userService;

    @Test
    void bean() {
        assertThat(this.userService).isNotNull();
    }
}
```

### upgradeLevels()

```java
package com.example.tobby.user;

import com.example.tobby.user.dao.UserDao;
import com.example.tobby.user.domain.Level;
import com.example.tobby.user.domain.User;

import java.util.List;

public class UserService {
    UserDao userDao;

    public void setUserDao(UserDao userDao) {
        this.userDao = userDao;
    }

    public void upgradeLevels() {
        List<User> users = userDao.getAll();
        for (User user : users) {
            Boolean changed = null;
            if (user.getLevel() == Level.BASIC && user.getLogin() >= 50) {
                user.setLevel(Level.SILVER);
                changed = true;
            } else if (user.getLevel() == Level.SILVER && user.getRecommend() >= 30) {
                user.setLevel(Level.GOLD);
                changed = true;
            } else if (user.getLevel() == Level.GOLD) {
                changed = false;
            } else {
                changed = false;
            }

            if (changed) {
                userDao.update(user);
            }
        }
    }
}

```

### upgradeLevels() test

ë ˆë²¨ basic, silver, gold ì¤‘ ë³€ê²½ì´ ì¼ì–´ë‚˜ëŠ” basic, silver ê³ ë ¤í•´ì„œ ì´ 5ê°€ì§€ ì¼€ì´ìŠ¤í‹‘ í…ŒìŠ¤íŠ¸ í•´ì•¼ í•œë‹¤. 

```java
package com.example.tobby.user;

import com.example.tobby.user.dao.UserDao;
import com.example.tobby.user.domain.Level;
import com.example.tobby.user.domain.User;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.ContextConfiguration;
import org.springframework.test.context.junit.jupiter.SpringExtension;

import java.util.Arrays;
import java.util.List;

import static org.assertj.core.api.Assertions.assertThat;

@SpringBootTest
@ExtendWith(SpringExtension.class)
@ContextConfiguration(locations = "/test.xml")
class UserServiceTest {

    @Autowired
    UserService userService;
    @Autowired
    UserDao userDao;
    List<User> users;

    @BeforeEach
    public void setUp() {
        users = Arrays.asList(
                new User("bumjin", "ë°•ë²”ì§„", "p1", Level.BASIC, 49, 0),
                new User("joytouch", "ê°•ëª…ì„±", "p2", Level.BASIC, 50, 0),
                new User("erwins", "ì‹ ìŠ¹í•œ", "p3", Level.SILVER, 60, 29),
                new User("madnite1", "ì´ìƒí˜¸", "p4", Level.SILVER, 60, 30),
                new User("green", "ì˜¤ë¯¼ê·œ", "p5", Level.GOLD, 100, 100)
        );
    }

    @Test
    void bean() {
        assertThat(this.userService).isNotNull();
    }

    @Test
    public void upgradeLevels() {
        userDao.deleteAll();
        for (User user : users) userDao.add(user);
        userService.upgradeLevels();
        checkLevel(users.get(0), Level.BASIC);
        checkLevel(users.get(1), Level.SILVER);
        checkLevel(users.get(2), Level.SILVER);
        checkLevel(users.get(3), Level.GOLD);
        checkLevel(users.get(4), Level.GOLD);
    }

    private void checkLevel(User user, Level expectedLevel) {
        User userUpdate = userDao.get(user.getId());
        assertThat(userUpdate.getLevel()).isEqualTo(expectedLevel);
    }
}
```

## 1.4 UserService.add()

 ì²˜ìŒ ê°€ì…í•˜ ëŠ” ì‚¬ìš©ìëŠ” ê¸°ë³¸ì ìœ¼ë¡œ BASIC ë ˆë²¨ì´ì–´ì•¼ í•œë‹¤ëŠ” ë¶€ë¶„ì´ í•„ìš”í•˜ë‹¤. 

ğŸ¤”User í´ë˜ìŠ¤ì—ì„œ ì•„ì˜ˆ level í•„ë“œë¥¼ Level.BASICìœ¼ë¡œ ì´ˆê¸°í™”í•˜ëŠ” ê²ƒì€ ì–´ ë–¨ê¹Œ?
ì²˜ìŒ ê°€ì…í•  ë•Œë¥¼ ë¹¼ê³ ëŠ” í•„ìš” ì—†ëŠ” ì •ë³´ì¸ë° êµ³ì´?

ğŸ˜UserService ì— add()í•˜ë‚˜ íŒŒì„œ ë„£ì!

```java
 @Test
    public void add() {
        userDao.deleteAll();
        User userWithLevel = users.get(4);	 // GOLD ë ˆë²¨
        User userWithoutLevel = users.get(0);
        userWithoutLevel.setLevel(null);
        userService.add(userWithLevel);
        userService.add(userWithoutLevel);
        User userWithLevelRead = userDao.get(userWithLevel.getId());
        User userWithoutLevelRead = userDao.get(userWithoutLevel.getId());
        assertThat(userWithLevelRead.getLevel()).isEqualTo(userWithLevel.getLevel());
        assertThat(userWithoutLevelRead.getLevel()).isEqualTo(Level.BASIC);
    }
```

```java
    public void add(User user) {
        if (user.getLevel() == null) user.setLevel(Level.BASIC);
        userDao.add(user);
    }
```

### 1.5 ì½”ë“œ ê°œì„ 

### upgradeLevels( ) ë©”ì†Œë“œ ì½”ë“œì˜ ë¬¸ì œì 

for ë£¨í”„ ì†ì— ë“¤ì–´ ìˆëŠ” if/elseif/else ë¸”ë¡ë“¤ì´ ì½ê¸° ë¶ˆí¸í•˜ë‹¤
 ë§Œì•½ ìƒˆë¡œìš´ ë ˆë²¨ì´ ì¶”ê°€ëœë‹¤ë©´  Level ì´ëŠ„ë„ ìˆ˜ì •í•´ì•¼ í•˜ê³ , upgradeLevels()ì˜ ë ˆë²¨ ì—…ê·¸ë ˆì´ë“œ ë¡œì§ì„ ë‹´ì€ ì½”ë“œì—  if ì¡°ê±´ì‹ê³¼ ë¸”ë¡ì„ ì¶”ê°€í•´ì¤˜ì•¼ í•œë‹¤.

ğŸ˜ë³€ê²½ì´ ì¦ì€ ë‚´ìš©ì´ ì¶”ìƒì ì¸ ë¡œì§ì˜ íë¦„ê³¼ í•¨ê»˜ ì„ì—¬ ìˆë‹¤. 

### upgradeLevels( ) ë¦¬íŒ©í† ë§

ë ˆë²¨ì„ ì—…ê·¸ë ˆì´ë“œ í•˜ëŠ” ì‘ì—…ì˜ ê¸°ë³¸ íë¦„ë§Œ ë¨¼ì € ë§Œë“¤ì–´ë³´ì. 

```java
    public void upgradeLevels() {
        List<User> users = userDao.getAll();
        for (User user : users) {
            if (canUpgradeLevel(user)) upgradeLevel(user);
        }
    }
```

```java
    private void upgradeLevel(User user) {
        if (user.getLevel() == Level.BASIC) user.setLevel(Level.SILVER);
        else if (user.getLevel() == Level.SILVER) user.setLevel(Level.GOLD);
        userDao.update(user);
    }

    private boolean canUpgradeLevel(User user) {
        Level currentLevel = user.getLevel();
        switch (currentLevel) {
            case BASIC:
                return (user.getLogin() >= 50);
            case SILVER:
                return (user.getRecommend() >= 30);
            case GOLD:
                return false;
            default:
                throw new IllegalArgumentException("Unknown Level: " +
                        currentLevel);
        }
    }
```

ğŸ¤”upgradeLevel() ë©”ì†Œë“œ ì½”ë“œëŠ” ë§ˆìŒì— ì•ˆ ë“ ë‹¤. 
ì‚¬ìš©ì ì˜¤ë¸Œì íŠ¸ì˜ ë ˆë²¨ì •ë³´ë¥¼ ë‹¤ìŒ ë‹¨ê³„ë¡œ ë³€ê²½í•˜ê³ , ë³€ê²½ëœ ì˜¤ë¸Œì íŠ¸ë¥¼ DBì— ì—…ë°ì´íŠ¸í•˜ëŠ” ë‘ ê°€ì§€ ì‘ì—…ì„ ìˆ˜í–‰í•˜ê³  ìˆë‹¤..
ë ˆë²¨ì´ ëŠ˜ì–´ë‚˜ë©´ if ë¬¸ì´ ì ì  ê¸¸ì–´ì§ˆ ê²ƒì´ê³ , ë ˆë²¨ ë³€ê²½ ì‹œ ì‚¬ìš© ì ì˜¤ë¸Œì íŠ¸ì—ì„œ level í•„ë“œ ì™¸ì˜ ê°’ë„ ê°™ì´ ë³€ê²½í•´ì•¼ í•œë‹¤ë©´ if ì¡°ê±´ ë’¤ì— ë¶™ëŠ” ë‚´ìš©ë„  ì ì  ê¸¸ì–´ì§ˆ ê²ƒì´ë‹¤.

ğŸ˜ë¨¼ì € ë ˆë²¨ì˜ ìˆœì„œì™€ ë‹¤ìŒ ë‹¨ê³„ ë ˆë²¨ì´ ë¬´ì—‡ì¸ì§€ë¥¼ ê²°ì •í•˜ëŠ” ì¼ì€ Levelì—ê²Œ ë§¡ê¸°ì. 

```java
package com.example.tobby.user.domain;

public enum Level {
    GOLD(3, null), SILVER(2, GOLD), BASIC(1, SILVER);
    private final int value;
    private final Level next;

    public int intValue() {
        return value;
    }

    Level(int value, Level next) {
        this.value = value;
        this.next = next;
    }

    public static Level valueOf(int value) {
        return switch (value) {
            case 1 -> BASIC;
            case 2 -> SILVER;
            case 3 -> GOLD;
            default -> throw new AssertionError("Unknown value: " + value);
        };
    }
}

```

ğŸ˜ì‚¬ìš©ì ì •ë³´ê°€ ë°”ë€ŒëŠ” ë¶€ë¶„ì„ UserService ë©”ì†Œë“œì—ì„œ Userë¡œ ì˜®ê²¨ë³´ì

```java
package com.example.tobby.user.domain;

public class User {
    String id;
    String name;

    Level level;
    int login;
    int recommend;
    String password;

    public User() {
    }

    public User(String id, String name, String password, Level level,
                int login, int recommend) {
        this.id = id;
        this.name = name;
        this.password = password;
        this.level = level;
        this.login = login;
        this.recommend = recommend;
    }

...
    public void upgradeLevel() {
        Level nextLevel = this.level.nextLevel();
        if (nextLevel == null) {
            throw new IllegalStateException(this.level + "ì€ ì—…ê·¸ë ˆì´ë“œê°€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤");
        } else {
            this.level = nextLevel;
        }
    }
}

```

UserService ì˜ canUpgradeLevel() ë©”ì†Œë“œì—ì„œ ì—…ê·¸ë ˆì´ë“œ ê°€ëŠ¥ ì—¬ë¶€ë¥¼ ë¯¸ë¦¬ íŒë‹¨í•´ì£¼ê¸°ëŠ” í•˜ì§€ë§Œ,  User ì˜¤ë¸Œì íŠ¸ë¥¼ UserServiceë§Œ ì‚¬ìš©í•˜ëŠ” ê±´ ì•„ë‹ˆë¯€ë¡œ ìŠ¤ìŠ¤ë¡œ ì˜ˆì™¸ìƒí™©ì— ëŒ€í•œ ê²€ì¦ ê¸° ëŠ¥ì„ ê°–ê³  ìˆëŠ” í¸ì´ ì•ˆì „í•˜ë‹¤.

```java
    private void upgradeLevel(User user) {
        user.upgradeLevel();
        userDao.update(user);
    }
```

ê°„ê²°í•´ì¡Œë‹¤!

ğŸ˜ UserService, User, Levelì´ ë‚´ë¶€ ì •ë³´ë¥¼  ë‹¤ë£¨ëŠ” ìì‹ ì˜ ì±…ì„ì— ì¶©ì‹¤í•œ ê¸°ëŠ¥ì„ ê°–ê³  ìˆìœ¼ë©´ì„œ í•„ìš”ê°€ ìƒê¸°ë©´ ì´ëŸ° ì‘ì—…ì„ ìˆ˜í–‰í•´ ë‹¬ë¼ê³  ì„œë¡œ ìš”ì²­í•˜ëŠ” êµ¬ì¡°ë‹¤.

ì²˜ìŒ êµ¬í˜„í–ˆë˜ UserServiceì˜ upgradeLevels() ë©”ì†Œë“œëŠ” User ì˜¤ë¸Œì íŠ¸ì—ì„œ ë°ì´ í„°ë¥¼ ê°€ì ¸ì™€ì„œ ê·¸ê²ƒì„ ê°€ì§€ê³  User ì˜¤ë¸Œì íŠ¸ë‚˜ Level ì´ëŠ„ì´ í•´ì•¼ í•  ì‘ì—…ì„ ëŒ€ì‹  ìˆ˜í–‰ í•˜ê³  ì§ì ‘ User ì˜¤ë¸Œì íŠ¸ì˜ ë°ì´í„°ë¥¼ ë³€ê²½í•´ë²„ë¦°ë‹¤. ì´ë³´ë‹¤ëŠ” UserServiceëŠ” Userì—ê²Œ  â€œë ˆë²¨ ì—…ê·¸ë ˆì´ë“œ ì‘ì—…ì„ í•´ë‹¬ë¼â€ê³  ìš”ì²­í•˜ê³ , ë˜ UserëŠ” Levelì—ê²Œ â€œë‹¤ìŒ ë ˆë²¨ì´ ë¬´ì—‡ì¸ ì§€ ì•Œë ¤ë‹¬ë¼â€ê³  ìš”ì²­í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ë™ì‘í•˜ê²Œ í•˜ëŠ” ê²ƒì´ ë°”ëŒì§í•˜ë‹¤.

### User test

upgradeLevel()ì„ í…ŒìŠ¤íŠ¸í•˜ì. 

```java
package com.example.tobby.user.domain;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

import static org.assertj.core.api.Assertions.assertThat;
import static org.junit.jupiter.api.Assertions.assertThrows;

class UserTest {
    User user;

    @BeforeEach
    public void setUp() {
        user = new User();
    }

    @Test
    void upgradeLevel() {
        Level[] levels = Level.values();
        for (Level level : levels) {
            if (level.nextLevel() == null) continue;
            user.setLevel(level);
            user.upgradeLevel();
            assertThat(user.getLevel()).isEqualTo(level.nextLevel());
        }
    }

    @Test
    public void cannotUpgradeLevel() {
        Level[] levels = Level.values();
        for (Level level : levels) {
            if (level.nextLevel() != null) continue;
            user.setLevel(level);
            assertThrows(IllegalStateException.class, () -> user.upgradeLevel());
        }
    }
}
```

###  UserServiceTest ê°œì„ 

Levelì´ ê°–ê³  ìˆì–´ì•¼ í•  ë‹¤ìŒ ë ˆë²¨ì´ ë¬´ì—‡ì¸ê°€ í•˜ëŠ” ì •ë³´ë¥¼ í…ŒìŠ¤íŠ¸ì—  ì§ì ‘ ë„£ì–´ë‘˜ ì´ìœ ê°€ ì—†ë‹¤.  ë¦¬íŒ©í† ë§ ã„±ã„±

```java
    @Test
    public void upgradeLevels() {
        userDao.deleteAll();
        for (User user : users) userDao.add(user);
        userService.upgradeLevels();
        checkLevelUpgraded(users.get(0), false);
        checkLevelUpgraded(users.get(1), true);
        checkLevelUpgraded(users.get(2), false);
        checkLevelUpgraded(users.get(3), true);
        checkLevelUpgraded(users.get(4), false);
    }

    private void checkLevelUpgraded(User user, boolean upgraded) {
        User userUpdate = userDao.get(user.getId());
        if (upgraded) {
            assertThat(userUpdate.getLevel()).isEqualTo(user.getLevel().nextLevel());
        }
        else {
            assertThat(userUpdate.getLevel()).isEqualTo(user.getLevel());
        }
    }
```

ğŸ¤”ì½”ë“œì— ë‚˜íƒ€ë‚œ ì¤‘ë³µì„ ì œê±°í•´ë³´ì. ì—…ê·¸ë ˆì´ë“œ ì¡°ê±´ì¸ ë¡œê·¸ì¸ íšŸìˆ˜ì™€ ì¶”ì²œ íšŸ ìˆ˜ê°€ ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œì™€ í…ŒìŠ¤íŠ¸ ì½”ë“œì— ì¤‘ë³µë¼ì„œ ë‚˜íƒ€ë‚œë‹¤

```java
case BASIC: return (user.getLogin() >= 50); // UserService
new User("joytouch", "ê°•ëª…ì„±", "p2", Level.BASIC, 50, 0) // UserServiceTest
```

ìƒìˆ˜ ê°’ì„ ì¤‘ë³µí•˜ëŠ” ê±´ ë°”ëŒì§í•˜ì§€ ëª»í•˜ë‹¤. ê¸°ì¤€ì´ ë˜ëŠ” ìµœì†Œ ë¡œê·¸ì¸ íšŸìˆ˜ê°€ ë³€ê²½ë   ë•Œë„ í•œ ë²ˆë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆë„ë¡ ë§Œë“¤ì. 

```java
    public static final int MIN_LOGCOUNT_FOR_SILVER = 50;
    public static final int MIN_RECCOMEND_FOR_GOLD = 30;
    private boolean canUpgradeLevel(User user) {
        Level currentLevel = user.getLevel();
        switch (currentLevel) {
            case BASIC:
                return (user.getLogin() >= MIN_LOGCOUNT_FOR_SILVER);
            case SILVER:
                return (user.getRecommend() >= MIN_RECCOMEND_FOR_GOLD);
            case GOLD:
                return false;
            default:
                throw new IllegalArgumentException("Unknown Level: " +
                        currentLevel);
        }
    }
```

```java
    @BeforeEach
    public void setUp() {
        users = Arrays.asList(
                new User("bumjin", "ë°•ë²”ì§„", "p1", Level.BASIC, MIN_LOGCOUNT_FOR_SILVER-1, 0),
                new User("joytouch", "ê°•ëª…ì„±", "p2", Level.BASIC, MIN_LOGCOUNT_FOR_SILVER, 0),
                new User("erwins", "ì‹ ìŠ¹í•œ", "p3", Level.SILVER, 60, MIN_RECCOMEND_FOR_GOLD-1),
                new User("madnite1", "ì´ìƒí˜¸", "p4", Level.SILVER, 60, MIN_RECCOMEND_FOR_GOLD),
                new User("green", "ì˜¤ë¯¼ê·œ", "p5", Level.GOLD, 100, Integer.MAX_VALUE)
        );
    }
```

ë ˆë²¨ì„ ì—…ê·¸ë ˆì´ë“œí•˜ëŠ” ì •ì±…ì„ ìœ ì—°í•˜ê²Œ ë³€ê²½í•  ìˆ˜ ìˆë„ë¡ ê°œì„ í•´ë³´ì.

ì‚¬ìš©ì ì—…ê·¸ë ˆì´ë“œ ì •ì±…ì„ UserServiceì—ì„œ ë¶„ë¦¬í•˜ê¸° ìœ„í•´ ë¶„ë¦¬ëœ ì—…ê·¸ë ˆì´ë“œ ì •ì±…ì„ ë‹´ì€ ì˜¤ë¸Œì íŠ¸ëŠ” DIë¥¼ í†µí•´ UserServiceì— ì£¼ì…í•œë‹¤. 

ì—…ê·¸ë ˆì´ë“œ ì •ì±…ì„ ë‹´ì€ ì¸í„°í˜ì´ìŠ¤

```java
package com.example.tobby.user;

import com.example.tobby.user.domain.User;

public interface UserLevelUpgradePolicy {
    boolean canUpgradeLevel(User user);
    void upgradeLevel(User user);
}

```

# 2. íŠ¸ëœì­ì…˜ ì„œë¹„ìŠ¤ ì¶”ìƒí™”

ğŸ¤”â€œì •ê¸° ì‚¬ìš©ì ë ˆë²¨ ê´€ë¦¬ ì‘ì—…ì„ ìˆ˜í–‰í•˜ëŠ” ë„ì¤‘ì— ë„¤íŠ¸ì›Œí¬ê°€ ëŠê¸°ê±°ë‚˜ ì„œë²„ì— ì¥ì• ê°€  ìƒê²¨ì„œ ì‘ì—…ì„ ì™„ë£Œí•  ìˆ˜ ì—†ë‹¤ë©´, 
ê·¸ë•Œê¹Œì§€ ë³€ê²½ëœ ì‚¬ìš©ìì˜ ë ˆë²¨ì€ ê·¸ëŒ€ë¡œ ë‘˜ê¹Œìš”? ì•„ë‹ˆ ë©´ ëª¨ë‘ ì´ˆê¸° ìƒíƒœë¡œ ë˜ëŒë ¤ ë†“ì•„ì•¼ í• ê¹Œìš”?"

ğŸ˜ê·¸ë•Œê¹Œì§€ ì§„í–‰ëœ ë³€ê²½ ì‘ì—…ë„ ëª¨ë‘ ì·¨ì†Œ ì‹œì¼œì•¼ì§€ ê·¸ê±¸ ë§ì´ë¼ê³  í•¨?

## 2.1 ëª¨ ì•„ë‹ˆë©´ ë„

ì§€ê¸ˆ ì½”ë“œë¡œ ì‚¬ìš©ì ë ˆë²¨ ì—…ê·¸ë ˆì´ë“œê°€ ì¤‘ê°„ì— ì¤‘ë‹¨ë˜ë©´ ì–´ì¼€ë ê¹Œ?

### í…ŒìŠ¤íŠ¸ìš©  UserServiceëŒ€ì—­

ì‘ì—… ì¤‘ê°„ì— ì˜ˆì™¸ë¥¼ ê°•ì œë¡œ ë§Œë“¤ ìˆ˜ ìˆì„ê¹Œ? 
ê°€ì¥ ì‰¬ìš´ ë°©ë²•ì€ ì˜ˆì™¸ë¥¼ ê°•ì œë¡œ ë°œ ìƒì‹œí‚¤ë„ë¡ ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œë¥¼ ìˆ˜ì •í•˜ëŠ” ê²ƒì€ ë‹¤ë§¤ë‹¤ìš”.

ë³´í†µ UserServiceë¥¼ ëŒ€ì‹ í•´ì„œ í…ŒìŠ¤íŠ¸ì˜ ëª©ì ì—  ë§ê²Œ ë™ì‘í•˜ëŠ” í´ë˜ìŠ¤ë¥¼ ë§Œë“¤ì–´ ì‚¬ìš©í•œë‹¤. ê·¸ëŸ¼ ì–´ë–»ê²Œ ë§Œë“¤ê¹Œ? UserServiceìƒì†í•´ë‹¤ê°€ í•„ìš”í•œ ë©”ì†Œë“œë§Œ ì˜¤ë²„ë¼ì´ë”© í•˜ë©´ ë˜ì§€ ë­.

```java
    static class TestUserService extends UserService {
        private String id;
        private TestUserService(String id) {
            this.id = id;
        }
        protected void upgradeLevel(User user) {
            if (user.getId().equals(this.id)) throw new TestUserServiceException();
            super.upgradeLevel(user);
        }

        
    }
    static class TestUserServiceException extends RuntimeException {
    }
```

### ê°•ì œ ì˜ˆì™¸ ë°œìƒì„ í†µí•œ í…ŒìŠ¤íŠ¸

ì‚¬ìš©ì ë ˆë²¨ ì—…ê·¸ë ˆì´ë“œë¥¼ ì‹œë„í•˜ë‹¤ê°€ ì¤‘ê°„ ì— ì˜ˆì™¸ê°€ ë°œìƒí–ˆì„ ê²½ìš°, ê·¸ ì „ì— ì—…ê·¸ë ˆì´ë“œí–ˆë˜ ì‚¬ìš©ìë„ ë‹¤ì‹œ ì›ë˜ ìƒíƒœë¡œ ëŒì•„ê°”ëŠ” ì§€ë¥¼ í™•ì¸í•˜ëŠ” ê²ƒì´ë‹¤

```java
    @Test
    public void upgradeAllorNothing() {
        TestUserService testUserService = new TestUserService(users.get(3).getId());
        testUserService.setUserDao(this.userDao);
        userDao.deleteAll();
        for (User user : users) userDao.add(user);
        try {
            testUserService.upgradeLevels();
            fail("err");
        } catch (TestUserServiceException e) {
        }
        checkLevelUpgraded(users.get(1), false);
    }

    static class TestUserService extends UserService {
        private final String id;

        private TestUserService(String id) {
            this.id = id;
        }

        protected void upgradeLevel(User user) {
            if (user.getId().equals(this.id)) throw new TestUserServiceException();
            super.upgradeLevel(user);
        }
    }

    static class TestUserServiceException extends RuntimeException {
    }
```

ì–´ë¦¼ë„ ì—†ì§€ ë¡¤ë°± ì•ˆëì—ˆë„¤!

### í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ì˜ ì›ì¸

íŠ¸ëœì­ì…˜ì´ ì ìš© ì•ˆëœê²Œ ë¬¸ì œë‹¤. 

> íŠ¸ëœì­ì…˜ 
>
> * ë” ì´ìƒ ë‚˜ëˆŒ ìˆ˜ ì—†ëŠ” ë‹¨ìœ„ ì‘ì—…
> * ì „ì²´ê°€  ë‹¤ ì„±ê³µí•˜ë“ ì§€ ì•„ë‹ˆë©´ ì „ì²´ê°€ ë‹¤ ì‹¤íŒ¨

## 2.2 íŠ¸ëœì­ì…˜ ê²½ê³„ ì„¤ì •

DBëŠ” ê·¸ ìì²´ë¡œ ì™„ë²½í•œ íŠ¸ëœì­ì…˜ì„ ì§€ì›í•œë‹¤

í•˜ë‚˜ì˜ SQL ëª…ë ¹ì„  ì²˜ë¦¬í•˜ëŠ” ê²½ìš°ëŠ” DBê°€ íŠ¸ëœì­ì…˜ì„ ë³´ì¥í•´ì¤€ë‹¤ê³  ë¯¿ì„ ìˆ˜ ìˆë‹¤.

í•˜ì§€ë§Œ ì—¬ëŸ¬ ê°œì˜ SQLì´ ì‚¬ìš©ë˜ëŠ” ì‘ì—…ì„ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ì·¨ê¸‰í•´ì•¼ í•˜ëŠ” ê²½ìš° ë„ ìˆë‹¤. 
ì—¬ê¸°ì„œ íŠ¸ëœì­ì…˜ ì•ˆì—ì„œ ë¬¸ì œê°€ ìƒê¸°ë©´ ì•ì—ì„œ ì§„í–‰í•œ ì‘ì—…ì„ ì·¨ì†Œí•´ì•¼ í•˜ëŠ”ë° ì´ì‘ transaction rollbackì´ë¼ê³  í•œë‹¤. 
ëª¨ë“  SQL ìˆ˜í–‰ ì‘ì—…ì´ ë‹¤  ì„±ê³µì ìœ¼ë¡œ ë§ˆë¬´ë¦¬ëë‹¤ê³  DBì— ì•Œë ¤ì¤˜ì„œ ì‘ì—…ì„ í™•ì •ì‹œì¼œì•¼ í•˜ëŠ”ë° ì´ë¥¼  íŠ¸ëœì­ì…˜ ì»¤ë°‹ transaction commitì´ë¼ê³  í•œë‹¤.

> ë¡¤ë°± : ëª¨ë“  ì‘ì—…ì„ ë¬´íš¨í™”
> ì»¤ë°‹: ëª¨ë“  ì‘ì—…ì„ ë‹¤ í™•ì •
> íŠ¸ëœì­ì…˜ì˜ ê²½ê³„ : íŠ¸ëœì­ì…˜ì´ ì‹œì‘í•˜ê³  ëë‚˜ëŠ” ìœ„ì¹˜

### JDBC íŠ¸ëœì­ì…˜ ê²½ê³„ ì„¤ì •

ëª¨ë“  íŠ¸ëœì­ì…˜ì€ ì‹œì‘í•˜ëŠ” ì§€ì ê³¼ ëë‚˜ëŠ” ì§€ì ì´ ìˆë‹¤. 
ì‹œì‘í•˜ëŠ” ë°©ë²•ì€ í•œ ê°€ì§€ì´ì§€ë§Œ  ëë‚˜ëŠ” ë°©ë²•ì€ ë‘ ê°€ì§€ë‹¤. 
ëª¨ë“  ì‘ì—…ì„ ë¬´íš¨í™”í•˜ëŠ” ë¡¤ë°±ê³¼ ëª¨ë“  ì‘ì—…ì„ ë‹¤ í™•ì •í•˜ëŠ” ì»¤ë°‹ì´ë‹¤. 

JDBCì˜ íŠ¸ëœì­ì…˜ì€ í•˜ë‚˜ì˜ Connectionì„ ê°€ì ¸ì™€ ì‚¬ìš©í•˜ë‹¤ê°€ ë‹«ëŠ” ì‚¬ì´ì—ì„œ ì¼ì–´ë‚œë‹¤.

JDBC ì—ì„œ 
íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•˜ë ¤ë©´ ìë™ì»¤ë°‹ ì˜µì…˜ì„ falseë¡œ ë§Œë“¤ì–´ì£¼ë©´ ëœë‹¤.
íŠ¸ëœì­ì…˜ì„ ì¢…ë£Œí•˜ë ¤ë©´ commit() ë˜ëŠ” rollback()ì„ í•˜ë©´ ì‘ì—… ê²°ê³¼ê°€ DBì— ë°˜ì˜ ë˜ê±°ë‚˜ ì·¨ì†Œëœë‹¤.

```java
        Connection c = new SimpleDriverDataSource().getConnection();
        c.setAutoCommit(false); //transaction ì‹œì‘!
        try {
            PreparedStatement st1 = c.prepareStatement("update users set ..");
            st1.executeUpdate();
            PreparedStatement st2 = c.prepareStatement("delete users ...");
            st2.executeUpdate();
            c.commit(); //transaction commit!
        } catch (Exception e) {
            c.rollback();
        }
        c.close();
```

DB ì»¤ë„¥ì…˜ ì•ˆì—ì„œ ë§Œë“¤ì–´ì§€ëŠ” íŠ¸ëœì­ì…˜ì„ ë¡œì»¬ íŠ¸ëœì­ì…˜local transactionì´ë¼ í•œë‹¤.

### UserServiceì™€ UserDaoì˜ íŠ¸ëœì­ì…˜ ë¬¸ì œ

ğŸ¤”ì–´ì§¸ì„œ userServiceì˜ upgradeLevels()ì—ëŠ” íŠ¸ëœì­ì…˜ì´ ì ìš©ë˜ì§€ ì•Šì•˜ë‚˜? 
ë°”ë¡œ íŠ¸ëœì­ì…˜ì˜ ê²½ê³„ë¥¼ ì„¤ì •í•˜ëŠ” ì½”ë“œê°€ ì—†ì—ˆê¸° ë•Œë¬¸ì´ë‹¤.
ê·¸ë˜ì„œ Dao method ë¥¼ í˜¸ì¶œí•  ë•Œ ë§ˆë‹¤ í•˜ë‚˜ì˜ ìƒˆë¡œìš´ íŠ¸ëœì­ì…˜ì´ ë§Œë“¤ì–´ì¡Œë‹¤!
~~ê·¸ëŸ¬ê²Œ UserDaoì—ì„œ connection ë§¤ë²ˆ ìƒˆë¡œ ë§Œë“¤ë¼ë””?~~

### ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ë‚´ì˜ íŠ¸ëœì­ì…˜ ê²½ê³„ ì„¤ì •

ğŸ¤”upgradeLevels()... ì‹¤í–‰í•  ì¿¼ë¦¬ê°€ ë§ì€ë° ë§¤ ì¿¼ë¦¬ë§ˆë‹¤ íŠ¸ëœì­ì…˜ì´ ë§Œë“¤ì–´ì§€ëŠ” ì´ ë†ˆì„,  Daoì•ˆì—  ë„£ì–´ì„œ ìœ„ì— ì½”ë“œ ì²˜ëŸ¼ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ì²˜ë¦¬í•˜ëŠ”ê±´ ì–´ë–¨ê¹Œ?

ğŸ˜ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì´ë‘ ë°ì´í„° ë¡œì§ì´ í•œë° ì„ì´ì–ì•„.. ì•ˆë¼.
ê²°êµ­ íŠ¸ëœì­ì…˜ ê²½ê³„ ì„¤ì • ì‘ì—…ì„ UserServiceìª½ì—ì„œ í•´ì•¼ê² êµ°. ê·¸ë ‡ë‹¤ë©´,,, DB ì»¤ë„¥ì…˜ë„ ì´ ë¬¸ì œì˜ upgradeLevels() ì•ˆì—ì„œ ë§Œë“¤ê³  ì¢…ë£Œí•´ì•¼ê² êµ°?

```java
//UserService.java
public void upgradeLevels() throws Exception { 
	 (1) DB Connection ìƒì„±
	 (2) íŠ¸ëœì­ì…˜ ì‹œì‘
    try {
         (3) DAO ë©”ì†Œë“œ í˜¸ì¶œ	 	 	
         (4) íŠ¸ëœì­ì…˜ ì»¤ë°‹
    }
    catch(Exception e) {
         (5) íŠ¸ëœì­ì…˜ ë¡¤ë°±
     	throw e;
    }
    finally {
         (6) DB Connection ì¢…ë£Œ
    }
}
```

```java
public interface UserDao {
public void add(Connection c, User user);
public User get(Connection c, String id);
...
public void update(Connection c, User user1);
}
```

![Image](https://github.com/mtak0235/TIL/assets/48946398/b48acb10-60ec-4711-a27f-9edb3b774dd8)

###  UserService íŠ¸ëœì­ì…˜ ê²½ê³„ ì„¤ì •ì˜ ë¬¸ì œì 

1.  DB connectionì„ ë¹„ë¡¯í•œ ë¦¬ì†ŒìŠ¤ë¥¼ ê¹”ë”í•˜ê²Œ ì •ë¦¬í•  ìˆ˜ ìˆê²Œ í•´ ì¤€ JDBC Templateì„ ë”ì´ìƒ ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤. 
2. DAOì˜ ë©”ì†Œë“œì™€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ë‹´ê³  ìˆëŠ” UserServiceì˜ ë©”ì†Œë“œì—  Connection parameterê°€ ë§¤ë²ˆ ê³„ì† ì „ë‹¬ë˜ì•¼ í•œë‹¤. 
   ì‹±ê¸€í†¤ìœ¼ë¡œ ë§Œë“   UserServiceì— Connection ì„ ë¯¸ë¦¬ ë§Œë“¤ì–´ ë‘˜ìˆ˜ë„ ì—†ëŠ”ê²Œ, ë©€í‹°ì“°ë ˆë“œ í™˜ê²½ì—ì„œ ì •ë³´ë¥¼ ì„œë¡œ ë®ì–´ì“°ëŠ” ì¼ì´ ë°œìƒí•˜ê¸° ë•Œë¬¸ì´ë‹¤. 
3. Connection parameterê°€ UserDao ì¸í„°í˜ì´ìŠ¤ ë©”ì†Œë“œì— ì¶”ê°€ë˜ë©´ UserDaoëŠ” ë” ì´ìƒ ë°ì´í„° ì ‘ê·¼ ê¸°ìˆ ì— ë…ë¦½ì ì¼ ìˆ˜ ì—†ë‹¤. 
4. Dao methodì— Connectin parameterë¥¼ ë°›ê²Œ í•˜ë©´ ì´ì œëŠ” í…ŒìŠ¤íŠ¸ ì½”ë“œì—ì„œë„ ì§ì ‘ Connection objë¥¼ ì¼ì¼ì´ ë§Œë“¤ì–´ì„œ Dao methodë¥¼ í˜¸ì¶œí•˜ê²Œ ëª¨ë‘ ë³€ê²½í•´ì•¼ í•œë‹¤. 

## 2.3 íŠ¸ëœì­ì…˜ ë™ê¸°í™”

### Connection parameterì œê±°

ğŸ¤”ì—¬ì „íˆ upgradeLevels()ì— transaction ê²½ê³„ ì„¤ì •ì„ í•´ì•¼ í•˜ëŠ” ê²ƒì€ ê°™ë‹¤. 
(= ê·¸ ì•ˆì—ì„œ  Connection ì„ ë§Œë“¤ê³  transactionì˜ ì‹œì‘ê³¼ ì¢…ë£Œë¥¼ í•´ì¤˜ì•¼í•œë‹¤.)
 But Connection objë¥¼ ê³„ì† ë©”ì†Œë“œì˜ parameterë¡œ ì „ë‹¬í•˜ë‹¤ê°€ Daoë¥¼ í˜¸ì¶œí•  ë•Œ ì‚¬ìš©í•˜ê²Œ í•˜ëŠ” ê²ƒë§Œí¼ì€ ì‹«ë‹¤. 

ğŸ˜UserServiceì—ì„œ transactionì„ ì‹œì‘í•˜ê¸° ìœ„í•´ ë§Œë“  connection objë¥¼ íŠ¹ë³„í•œ ì €ì¥ì†Œì— ë³´ê´€í•´ ë‘ê³ , ì´í›„ì— í˜¸ì¶œë˜ëŠ” Daoì˜ methodì—ì„œëŠ” ê·¸ë ‡ê²Œ ì €ì¥ëœ connectionì„ ê°€ì ¸ë‹¤ ì“°ê²Œ í•  ìˆ˜ ìˆë‹¤. ì´ë¥¼ **transaction synchronization**ì´ë¼ í•œë‹¤. 
ì¦‰, Daoê°€ ì“°ëŠ” jdbcTemplateì´ transaction syncë¥¼ ì“°ë„ë¡ ë§Œë“ ë‹¤. 

![image-20230729065230532](.\assets\image-20230729065230532.png)

1. UserServiceê°€ Connectionì„ ë§Œë“¤ì–´ setAutoCommit(false)í•˜ê³ 
2. TransActionSynchronizations ì €ì¥ì†Œì— ì €ì¥í•´ë‘ê³ 
3. update()ê°€ ì‹¤í–‰ë˜ë©´ ë‚´ë¶€ì ìœ¼ë¡œ 
4. TransActionSynchronizations ì €ì¥ì†Œì— ì¢€ ì „ì— ì €ì¥í•´ ë†¨ë˜ Connectionì„ ê°€ì ¸ì™€
5. PreparedStatementë¥¼ ë§Œë“¤ì–´ sqlì„ executeSql()í•œë‹¤. 
6. update()ì‹¤í–‰ë˜ê³ 
7. TransActionSynchronizations ì €ì¥ì†Œì—ì„œ Connection ê°€ì ¸ì™€
8. ì‚¬ìš©í•œë‹¤

9. ~ ë°˜ë³µ

12. transactioní•„ìš”í•œ ì‘ì—… ë‹¤ ëë‚¬ìœ¼ë©´ Connection.commit() ë˜ëŠ” Connection.rollback() í›„ Connection.close()

TransActionSynchronizations ì €ì¥ì†ŒëŠ” ìŠ¤ë ˆë“œ ë§ˆë‹¤ ë…ë¦½ì ìœ¼ë¡œ ìƒì„±ë˜ê¸°ì— ë‹¤ì¤‘ ì‚¬ìš©ìë¥¼ ì²˜ë¦¬í•˜ëŠ” í™˜ê²½ì—ë„ ì¶©ëŒì´ ì—†ë‹¤. 

### íŠ¸ëœì­ì…˜ ë™ê¸°í™” ì ìš©

```java
public class UserService {
    public static final int MIN_LOGCOUNT_FOR_SILVER = 50;
    public static final int MIN_RECCOMEND_FOR_GOLD = 30;
    UserDao userDao;
    private DataSource dataSource;

    public void setUserDao(UserDao userDao) {
        this.userDao = userDao;
    }

    public void setDataSource(DataSource dataSource) {
        this.dataSource = dataSource;
    }

    public void upgradeLevels() throws SQLException {
        TransactionSynchronizationManager.initSynchronization(); //ë™ê¸°í™” ì‘ì—… ì´ˆê¸°í™”
        Connection c = DataSourceUtils.getConnection(dataSource); //DB Connection ìƒì„± ë° ì‹œì‘
        c.setAutoCommit(false);
        try {
            List<User> users = userDao.getAll();
            for (User user : users) {
                if (canUpgradeLevel(user)) upgradeLevel(user);
            }
            c.commit();
        } catch (Exception e) {
            c.rollback();
            throw e;
        } finally {
            DataSourceUtils.releaseConnection(c, dataSource); //connection ë‹«ê¸°
            TransactionSynchronizationManager.unbindResource(this.dataSource); // ë™ê¸°í™” ì‘ì—… ~
            TransactionSynchronizationManager.clearSynchronization(); // ì¢…ë£Œ ë¹› ì •ë¦¬
        }
    }
    ...
}
```

ğŸ¤”dataSourceì—ì„œ connectionì•ˆê°€ì ¸ì˜¤ê³  ìŠ¤í”„ë§ì´ ì œê³µí•˜ëŠ” DataSourceUtilsë¡œ í•˜ì§€?
ê·¸ë†ˆì´ Connection objë¥¼ ë§Œë“¤ ë¿ ì•„ë‹ˆë¼, ì €ì¥ì†Œì— ë°”ì¸ë”©ê¹Œì§€ í•´ì£¼ê¸° ë•Œë¬¸ì´ì§€.

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd">
    <bean id="connectionMaker" class="com.example.tobby.user.dao.DConnectionMaker"/>
    <bean id="userDao" class="com.example.tobby.user.dao.UserDaoJdbc">
        <property name="dataSource" ref="dataSource"/>
    </bean>
    <bean id="dataSource" class="org.springframework.jdbc.datasource.SimpleDriverDataSource">
        <property name="driverClass" value="com.mysql.cj.jdbc.Driver"/>
        <property name="url" value="jdbc:mysql://localhost/tobby"/>
        <property name="username" value="tobaby"/>
        <property name="password" value="0000"/>
    </bean>
    <bean id="userService" class="com.example.tobby.user.UserService">
        <property name="dataSource" ref="dataSource"/>
        <property name="userDao" ref="userDao"/>
    </bean>ã…£
</beans>
```

### íŠ¸ëœì­ì…˜ í…ŒìŠ¤íŠ¸ ë³´ì™„

```java
    @Autowired
    DataSource dataSource;
    @Test
    public void upgradeAllorNothing() {
        UserService testUserService = new TestUserService(users.get(3).getId());
        testUserService.setUserDao(this.userDao);
        testUserService.setDataSource(this.dataSource);
        
        userDao.deleteAll();
        for (User user : users) userDao.add(user);
        try {
            testUserService.upgradeLevels();
            fail("err");
        } catch (TestUserServiceException | SQLException e) {
        }
        checkLevelUpgraded(users.get(1), false);
    }
```

### JdbcTemplateê³¼ íŠ¸ëœì­ì…˜ ë™ê¸°í™”

 ë§Œì•½ ë¯¸ë¦¬ ìƒì„±ë¼ì„œ íŠ¸ëœì­ ì…˜ ë™ê¸°í™” ì €ì¥ì†Œì— ë“±ë¡ëœ DB ì»¤ë„¥ì…˜ì´ë‚˜ íŠ¸ëœì­ì…˜ì´ ì—†ëŠ” ê²½ìš°ì—ëŠ” 
JdbcTemplate ì´ ì§ì ‘ DB ì»¤ë„¥ì…˜ì„ ë§Œë“¤ê³  íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•´ì„œ JDBC ì‘ì—…ì„ ì§„í–‰í•œë‹¤. 

ë°˜ë©´ì—  upgradeLevels() ë©”ì†Œë“œì—ì„œì²˜ëŸ¼ íŠ¸ëœì­ì…˜ ë™ê¸°í™”ë¥¼ ì‹œì‘í•´ë†“ì•˜ë‹¤ë©´ 
ê·¸ë•Œë¶€í„° ì‹¤í–‰ë˜ ëŠ” JdbcTemplateì˜ ë©”ì†Œë“œì—ì„œëŠ” ì§ì ‘ DB ì»¤ë„¥ì…˜ì„ ë§Œë“œëŠ” ëŒ€ì‹  
íŠ¸ëœì­ì…˜ ë™ê¸°í™” ì €ì¥ ì†Œì— ë“¤ì–´ ìˆëŠ” DB ì»¤ë„¥ì…˜ì„ ê°€ì ¸ì™€ì„œ ì‚¬ìš©í•œë‹¤. 
ì´ë¥¼ í†µí•´ ì´ë¯¸ ì‹œì‘ëœ íŠ¸ë™ì­ì…˜ì— ì°¸ ì—¬í•˜ëŠ” ê²ƒì´ë‹¤

## 2.4 íŠ¸ëœì­ì…˜ ì„œë¹„ìŠ¤ ì¶”ìƒí™”

### ê¸°ìˆ ê³¼ í™˜ê²½ì— ì¢…ì†ë˜ëŠ” íŠ¸ëœì­ì…˜ ê²½ê³„ ì„¤ì • ì½”ë“œ

ì§€ê¸ˆê¹Œì§€ ì½”ë“œëŠ” DBì—°ê²° ë°©ë²•ì´ ë°”ë€Œë©´ xmlë§Œ ìˆ˜ì •í•˜ë©´ ëœë‹¤. 
ğŸ¤”í•˜ì§€ë§Œ ë‚´ê°€ ë§Œë“  ì‚¬ìš©ì ê´€ë¦¬ ëª¨ë“ˆì„ ì‚¬ìš©í•  Gì‚¬ì—ì„œ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ ì•ˆì— ì—¬ëŸ¬ê°œì˜ DBì— ë°ì´í„°ë¥¼ ë„£ëŠ” ì‘ì—…ì„ í•  í•„ìš”ê°€ ë°œìƒí–ˆë‹¤. 
ìš°ë¦¬ê°€ ì‚¬ìš©ì¤‘ì¸ ë°©ì‹ì¸ local transactionì€ í•˜ë‚˜ì˜ DB connectionì— ì¢…ì†ë˜ê¸° ë•Œë¬¸ì— ì´ë ‡ê²Œ í•˜ë‚˜ì˜ transactionìœ¼ë¡œ ì—¬ëŸ¬ ê°œì˜ DB ì— ë°ì´í„°ë¥¼ ì €ì¥ í•˜ëŠ”ê±´ ë¶ˆ.ê°€.ëŠ¥

ğŸ˜ë³„ë„ì˜ transaction ê´€ë¦¬ìë¥¼ í†µí•´ global transaction ë°©ì‹ìœ¼ë¡œ ì „í™˜í•´ë³´ì. ì´ê±¸ë¡œëŠ” ì—¬ëŸ¬ê°œì˜ DBê°€ ì°¸ì—¬í•˜ëŠ” ì‘ì—…(ê·¸ë‹ˆê¹Œ JMSê°™ì€ íŠ¸ëœì­ì…˜ ê¸°ëŠ¥ì„ ì§€ì›í•˜ëŠ” ì„œë¹„ìŠ¤)ì„ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ë§Œë“¤ ìˆ˜ ìˆë‹¤. 

ìë°”ëŠ” global transaction ë„ ë˜ëŠ” transaction managerë¥¼ ì§€ì›í•˜ê¸° ìœ„í•´ JTA(java transaction api)ë¥¼ ì œê³µí•œë‹¤. 

ğŸ¤”JTAëŠ” ì–´ë–»ê²Œ ì—¬ëŸ¬ DBë“¤ê³¼ ë©”ì‹œì§• ì„œë²„ë“¤ì„ ì¢…í•©ì ìœ¼ë¡œ ì œì–´í•  ìˆ˜ ìˆëƒ?

resource managerì™€ XA protocolì´ ì´ transaction managerë¥¼ ì—°ê²°í•´ ì£¼ê¸° ë•Œë¬¸ì´ì§€ .

![image-20230729092510190](./assets/image-20230729092510190.png)

```java
InitialContext ctx = new InitialContext(); 
UserTransaction tx = (UserTransaction)ctx.lookup(USER_TX_JNDI_NAME);
//JNDIë¥¼ ì¨ì„œ UserTransaction objë¥¼ ê°€ì ¸ì˜¨ë‹¤. 
tx.begin(); 
Connection c = dataSource.getConnection();//JNDIë¡œ ê°€ì ¸ì˜¨ dataSourceì¨ì•¼ í•¨.
try {
	 // ë°ì´í„° ì•¡ì„¸ìŠ¤ ì½”ë“œ
tx.commit(); 
} catch (Exception e) { 
tx.rollback(); 
throw e;
} finally {
c.close();
}
```

ğŸ¤”ë¬¸ì œëŠ” ë§ì´ì£ ? transaction ì„ local to global í•˜ë ¤ë©´ UserServiceë¥¼ ìˆ˜ì •í•´ì•¼ í•œë‹¤ëŠ”ê±°ì•¼. ë¡œì§ë„ ì•ˆë°”ë€Œì—ˆëŠ”ë° ê¸°ìˆ  í™˜ê²½ì— ë”°ë¼ ì½”ë“œê°€ ë°”ë€Œì–´ë²„ë¦°ë‹¤ëŠ”ê±°ì§€.

ğŸ¤”ê·¸ ë¿ ì•„ë‹ˆì•¼. í•œë†ˆì´ ìê¸°ë“¤ì´ hibernateë¡œ UserDaoë¥¼ ë§Œë“¤ì–´ ì™”ë‹¤ë„¤? ì—¬ê¸°ê¹Œì§€ëŠ” ì¢‹ì•„ ì˜ ëŒ€ì‘í–ˆëŠ”ë°, ë¬¸ì œëŠ” JDBC ì™€ hibernateì˜ transaction ê´€ë¦¬ ì½”ë“œëŠ” ë‹¤ë¥´ë‹¤ëŠ”ê±°ì•¼. ê·¸ëŸ¬ë‹ˆê¹Œ ë˜ UserServiceë¥¼ ìˆ˜ì •í•´ì•¼ í•œë‹¤ëŠ” ê±°ì§€.

### íŠ¸ëœì­ì…˜ APIì˜ ì˜ì¡´ ê´€ê³„ ë¬¸ì œì™€ í•´ê²°ì±…

![image-20230729095004816](./assets/image-20230729095004816-1690591805463-1.png)

ğŸ¤”ê¸°ê» UserDaoë¡œ ë°ì´í„° ê¸°ìˆ ì„ ìœ ì—°í•˜ê²Œ ë°”ê¿”ë¼ìš¸ ìˆ˜ ìˆê²Œ ëëŠ”ë° transaction ë„ì…í•˜ë‹ˆê¹Œ ë˜ íŠ¹ì • ë°ì´í„° ì ‘ê·¼ ê¸°ìˆ ì— ì¢…ì†ë˜ê²Œ ëë„¤..

íŠ¸ëœì­ì…˜ ê²½ê³„ ì„¤ì • ë¶€ë¶„ì„ ì¶”ìƒí™” ì‹œí‚¬ê¹Œ? ê·¸ëŸ¼ í•˜ìœ„ ì‹œìŠ¤í…œì´ ë°”ë€Œì–´ë„ ì¼ê´€ì ìœ¼ë¡œ ì ‘ê·¼í•  ìˆ˜ ìˆì–ì•„. 

ğŸ˜ìš°ë¦¬ê°€ ì§ˆë¦¬ê²Œ ì¨ì™”ë˜ JDBCë„ ì „í˜€ ë‹¤ë¥¸ DB clientì™€ APIë¥¼  SQLì„ ì“´ë‹¤ëŠ” ê³µí†µì  í•˜ë‚˜ë¥¼ ì¶”ìƒí™” ì‹œí‚¨ê±°ë‹¤. 

JDBC, JTA, hibernate, JPA, JMS ì£„ë‹¤ transaction ì„ ë‹¤ë£¨ê³  ìˆìœ¼ë‹ˆ ì´ ê³µí†µì ì„ ëª¨ì•„ ì¶”ìƒí™”ëœ transaction ê´€ë¦¬ ê³„ì¸µì„ ë§Œë“¤ë©´ ê¸°ìˆ  ì¢…ì†ì ì´ì§€ ì•Šê²Œ ë§Œë“¤ ìˆ˜ ìˆê² ë‹¤!

### ìŠ¤í”„ë§ì˜ transaction service ì¶”ìƒí™”

ì´ë¯¸ ìŠ¤í”„ë§ì€ transaction ê¸°ìˆ ì˜ ê³µí†µì ë“¤ì„ ì¶”ìƒí™”í•œ **íŠ¸ëœì­ì…˜ ì¶”ìƒí™” ê¸°ìˆ **ì„ ì œê³µí•˜ê³  ìˆë‹¤!

![image-20230729095631883](./assets/image-20230729095631883.png)

ìŠ¤í”„ë§ì´ ì œê³µí•˜ëŠ” íŠ¸ëœì­ì…˜ ê²½ê³„ ì„¤ì •ì„ ìœ„í•œ ì¶”ìƒ ì¸í„°í˜ì´ìŠ¤ëŠ” PlatformTransactionManagerë‹¤. 
JDBCì˜ local transaction ì„ ì´ìš©í•œë‹¤ë©´ êµ¬í˜„ì²´ì¸ DataSourceTransactionManagerë¥¼ ì‚¬ìš©í•˜ë©´ ëœë‹¤. ì‚¬ìš©í•  DBì˜ dataSourceë§Œ ë§¤ê°œë³€ìˆ˜ë¡œ ì˜ ë„˜ê²¨ì£¼ë©´ ëœë‹¤ .

```java
    public void upgradeLevels() throws SQLException {
        PlatformTransactionManager transactionManager = new DataSourceTransactionManager(dataSource);
        TransactionStatus status = transactionManager.getTransaction(new DefaultTransactionDefinition());
        try {
            List<User> users = userDao.getAll();
            for (User user : users) {
                if (canUpgradeLevel(user)) upgradeLevel(user);
            }
            transactionManager.commit(status);
        } catch (Exception e) {
         
            transactionManager.rollback(status);
            throw e;
        } 
    }
```

íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•˜ëŠ” getTransaction()ë‚´ë¶€ì—ì„œ connection ê°€ì ¸ì™€ ì“´ë‹¤. 
ì´ ë•Œ ë§¤ê°œë³€ìˆ˜ë¡œ ë„˜ê¸°ëŠ” DefaultTransactionDefinitionì€ íŠ¸ëœì­ì…˜ì˜ ì†ì„±ì„ ë‹´ê³  ìˆë‹¤. 

ì´ë ‡ê²Œ ì‹œì‘ëœ transactionì€ TransactionStatusì— ì €ì¥ë˜ëŠ”ë° ì´ë†ˆì€ transaction ì— ëŒ€í•œ ì¡°ì‘ì´ í•„ìš”í•  ë•Œ PlatformTransactionManager methodì˜ ë§¤ê°œë³€ìˆ˜ë¡œ ë–¤ì ¸ì£¼ë©´ ëœë‹¤.

### íŠ¸ëœì­ì…˜ ê¸°ìˆ  ì„¤ì •ì˜ ë¶„ë¦¬

ì ê·¸ëŸ¼ transaction  ì¶”ìƒí™” APIë¥¼ ì ìš©í•œ UserServiceì½”ë“œë¥¼ JTAë¥¼ ì´ìš©í•˜ëŠ” global transaction ìœ¼ë¡œ ë°”ê¾¸ë ¤ë©´ ê°œì‰½ë‹¤.

PlatformTransactionManagerë¥¼ DatasourceTransactionManagerì—ì„œ JTATransactionManagerë¡œ ë°”ê¾¸ë©´ ëœë‹¤. 

hibernateë¡œ  UserDaoë§Œë“¤ì—ˆë‹¤ë©´  HibernateTransactionManagerë¥¼ 
JPAë¡œ ë§Œë“¤ì—ˆìœ¼ë©´ JPATransactionManagerë¥¼ ì“°ë©´ ëœë‹¤. 

ì ì´ì œ DIì›ì¹™ì„ ì¤€ìˆ˜í•˜ê²Œ ë§Œë“¤ì–´ë³´ì. DataSourceTransactionManagerë¥¼ ë¹ˆìœ¼ë¡œ ë“±ë¡í•˜ê³  UserServiceì— ì£¼ì…í•˜ë©´ ë˜ê² ë‹¤. 

```java
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd">
    <bean id="connectionMaker" class="com.example.tobby.user.dao.DConnectionMaker"/>
    <bean id="userDao" class="com.example.tobby.user.dao.UserDaoJdbc">
        <property name="dataSource" ref="dataSource"/>
    </bean>
    <bean id="dataSource" class="org.springframework.jdbc.datasource.SimpleDriverDataSource">
        <property name="driverClass" value="com.mysql.cj.jdbc.Driver"/>
        <property name="url" value="jdbc:mysql://localhost/tobby"/>
        <property name="username" value="tobaby"/>
        <property name="password" value="0000"/>
    </bean>
    <bean id="userService" class="com.example.tobby.user.UserService">
        <property name="userDao" ref="userDao"/>
        <property name="transactionManager" ref="transactionManager"/>
    </bean>
    <bean id="transactionManager" class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
        <property name="dataSource" ref="dataSource"/>
    </bean>
</beans>
```

```java
    @Autowired
    PlatformTransactionManager transactionManager;

    public void setTransactionManager(PlatformTransactionManager transactionManager) {
        this.transactionManager = transactionManager;
    }
```

# 3. ì„œë¹„ìŠ¤ ì¶”ìƒí™”ì™€ ë‹¨ì¼ ì±…ì„ì˜ ì›ì¹™

### ìˆ˜ì§, ìˆ˜í‰ ê³„ì¸µêµ¬ì¡°ì™€ ì˜ì¡´ ê´€ê³„

 UserDao, UserServiceëŠ” ë‘˜ ë‹¤ application logicì„ ë‹´ì€ ì½”ë“œì´ì§€ë§Œ, ë‚´ìš©ì— ë”°ë¼ ìˆ˜í‰ì ìœ¼ë¡œ ë¶„ë¦¬í–ˆë‹¤. 

í•˜ì§€ë§Œ transaction ì˜ ì¶”ìƒí™”ëŠ” application business logic ê³¼ ê·¸ í•˜ìœ„ì—ì„œ ë™ì‘í•˜ëŠ” transaction ê¸°ìˆ ì´ë¼ëŠ” ì•„ì˜ˆ ë‹¤ë¥¸ ê³„ì¸µì˜ íŠ¹ì„±ì„ ê°–ëŠ” ì½”ë“œë¥¼ ë¶„ë¦¬í–ˆë‹¤. 

![image-20230731162758728](./assets/image-20230731162758728.png)

