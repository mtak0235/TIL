# 1. ì‚¬ë¼ì§„ SQLException

## 

JdbcContextì—ì„œ JdbcTemplateìœ¼ë¡œ ë°”ê¾¸ë‹ˆê¹Œ ì˜ˆì™¸ë“¤ì´ ì‚¬ë¼ì¡Œë‹¤?!?

```java
public void deleteAll() throws SQLException {
this.jdbcContext.executeSql("delete from users");
}
```

```java
public void deleteAll() {
this.jdbcTemplate.update("delete from users");
}
```

## 1.1 ì´ˆë‚œê° ì˜ˆì™¸ ì²˜ë¦¬

### ì˜ˆì™¸ ë¸”ë™í™€

```java
try {
...
}
catch(SQLException e) {
}
```

ì˜¤ë¥˜ê°€ ìˆì–´ë„ ë¬´ì‹œí•˜ê³  ê³„ì† ì‹¤í–‰ë˜ê²Œ ëœë‹¤.  í™”ë©´ì— ì˜¤ë¥˜ë¥¼ ì¶œë ¥í•´ë„ ë§ˆì°¬ê°€ì§€ë‹¤. ê¸ˆë°© ë¬»íˆê² ì§€..

```java
} catch (SQLException e) {
System.out.println(e);
}
```

```java
} catch (SQLException e) {
e.printStackTrace();
}
```

âœ¨ëª¨ë“  ì˜ˆì™¸ëŠ” ì ì ˆí•˜ê²Œ ë³µêµ¬ ë˜ë“ ì§€ ì•„ë‹ˆë©´ ì‘ì—…ì„ ì¤‘ë‹¨ ì‹œí‚¤ê³  ìš´ì˜ì ë˜ëŠ” ê°œë°œìì—ê²Œ ë¶„ëª…í•˜ê²Œ í†µë³´ë¼ì•¼ í•œë‹¤. 
ì½˜ì†”ì´ë‚˜ ë¡œê·¸ì— ì˜ˆì™¸ ë©”ì‹œì§€ë¥¼ ì¶œë ¥í•  ë°”ì— ì°¨ë¼ë¦¬ ì´ê²Œ ë‚«ë‹¤ .

```java
} catch (SQLException e) {
e.printStackTrace();
System.exit(1);
}
```

ë¬¼ë¡  ì´ë ‡ê²Œ ì§œë¼ëŠ” ë§ì€ ì•„ë‹ˆë‹¤. ì˜ˆì™¸ ì¡ì•„ì„œ ì¡°ì¹˜í•  ë°©ë²•ì´ ì—†ìœ¼ë©´ ì°¨ë¼ë¦¬ ë°–ìœ¼ë¡œ ì±…ì„ì„ ë– ë„˜ê²¨ë¼. 

### ë¬´ì˜ë¯¸í•˜ê³  ë¬´ì±…ì„í•œ throws

```java
public void method1() throws Exception {
method2();
...
}
public void method2() throws Exception {
method3();
...
}
public void method3() throws Exception {
...
}
```

## 1.2 ì˜ˆì™¸ì˜ ì¢…ë¥˜ì™€ íŠ¹ì§•

ìë°”ì—ì„œ throwë¥¼ í†µí•´ ë°œìƒì‹œí‚¬ ìˆ˜ ìˆëŠ” ì˜ˆì™¸ 3ê°€ì§€

* Error

  * java.lang.Error ì˜ ì„œë¸Œ í´ë˜ìŠ¤
  * ì‹œìŠ¤í…œì— ë­”ê°€ ë¹„ì •ìƒì ì¸ ìƒí™©ì´ ë°œìƒí–ˆì„ ê²½ìš° ì‚¬ìš©ë¨.
  * OutOfMemoryError, ThreadDeath etc
  * ì£¼ë¡œ  VMì—ì„œ ë˜ì§ â¡application codeì—ì„œ ì¡ìœ¼ë ¤ê³  í•˜ë©´ ì•ˆëœë‹¤.

* Exception ê³¼ ì²´í¬ ì˜ˆì™¸

  * java.lang.Exceptionê³¼ ì„œë¸Œ í´ë˜ìŠ¤

  * ê°œë°œìë“¤ì´ ë§Œë“  applicationì½”ë“œì˜ ì‘ì—… ì¤‘ì— ì˜ˆì™¸ ìƒí™©ì´ ë°œìƒí–ˆì„ ê²½ìš°ì— ì‚¬ìš©

  * Exception í´ë˜ìŠ¤ ì¢…ë¥˜

    * ì²´í¬ ì˜ˆì™¸

      *  Exceptionì˜ ì„œë¸Œ í´ë˜ìŠ¤
      * RuntimeExceptionì„ ìƒì†ë°›ì§€ ì•Šì€ ê²ƒ
      * ì˜ˆì™¸ë¥¼ ì²˜ë¦¬í•˜ëŠ” ì½”ë“œ ë°˜ë“œì‹œ ì‘ì„±

    * unchecked exception

      * RuntimExceptionì„ ìƒì†í•œ í´ë˜ìŠ¤
      * ì˜ˆì™¸ì²˜ë¦¬ í•„ìˆ˜ ì•„ë‹˜
      * í”„ë¡œê·¸ë¨ì˜ ì˜¤ë¥˜ê°€ ìˆì„ ë•Œ ë°œìƒâ¡ê°œë°œì ê³¼ì‹¤
      * NullPointerException, IllegalArgumentException etc

      > RuntimeException
      > Exception ì˜ ì„œë¸Œ í´ë˜ìŠ¤

 ## 1.3 ì˜ˆì™¸ ì²˜ë¦¬ ë°©ë²•

### ì˜ˆì™¸ ë³µêµ¬

ì˜ˆì™¸ ìƒí™©ì„ íŒŒì•…í•˜ê³  ë¬¸ì œë¥¼ í•´ê²°í•´ì„œ ì •ìƒ ìƒíƒœë¡œ ëŒë ¤ë†“ìŒ.

Ex. 

ì‚¬ìš©ìê°€ ìš”ì²­í•œ íŒŒì¼ì„ ì½ìœ¼ë ¤ê³  ì‹œë„í–ˆëŠ”ë° í•´ë‹¹ íŒŒì¼ì´ ì—†ë‹¤ê±°ë‚˜ ë‹¤ë¥¸  ë¬¸ì œê°€ ìˆì–´ì„œ ì½íˆì§€ê°€ ì•Šì•„ì„œ IOExceptionì´ ë°œìƒ
â¡ì‚¬ìš©ì ì—ê²Œ ìƒí™©ì„ ì•Œë ¤ì£¼ê³  ë‹¤ë¥¸ íŒŒì¼ì„ ì´ìš©í•˜ë„ë¡ ì•ˆë‚´

ë‹¨,  IOException ì—ëŸ¬ ë©”ì‹œì§€ê°€ ì‚¬ìš©ìì—ê²Œ ê·¸ëƒ¥ ë˜ì ¸ì§€ëŠ” ê²ƒì€ ì˜ˆì™¸ ë³µêµ¬ë¼ê³  ë³¼ ìˆ˜ ì—†ë‹¤.

ì˜ˆì™¸ê°€ ì²˜ë¦¬ëìœ¼ë©´ ë¹„ë¡ ì‚¬ìš©ìì—ê²Œ ì˜ˆì™¸ ìƒí™©ìœ¼ë¡œ ë¹„ì³ë„ application ì•ˆì—ì„œëŠ” ì •ìƒì ìœ¼ë¡œ ì„¤ê³„ëœ íë¦„ì„ ë”°ë¼ê°€ì•¼ í•œë‹¤. 

 ë„¤íŠ¸ì›Œí¬ê°€ ë¶ˆì•ˆí•´ì„œ ê°€ë” ì„œë²„ì— ì ‘ì†ì´ ì˜ ì•ˆ ë˜ëŠ” ì—´ì•…í•œ í™˜ê²½ì— ìˆëŠ” ì‹œìŠ¤í…œì´ë¼ ì›ê²© DB ì„œë²„ì— ì ‘ì†í•˜ë‹¤ ì‹¤íŒ¨í•´ì„œ SQLExceptionì´ ë°œìƒí•˜ëŠ” ê²½ìš°â¡ ì¬ì‹œë„ í˜¹ì€ ì¼ì • ì‹œê°„ ëŒ€ê¸°í–ˆë‹¤ê°€ ë‹¤ì‹œ ì ‘ì†ì„ ì‹œë„

```java
int maxretry = MAX_RETRY;
while(maxretry -- > 0) {
    try {
             ... 	 	 	 // ì˜ˆì™¸ê°€ ë°œìƒí•  ê°€ëŠ¥ì„±ì´ ìˆëŠ” ì‹œë„
             return;		 	 // ì‘ì—… ì„±ê³µ
    }
    catch(SomeException e) {
             // ë¡œê·¸ ì¶œë ¥. ì •í•´ì§„ ì‹œê°„ë§Œí¼ ëŒ€ê¸°
    }
    finally {
             // ë¦¬ì†ŒìŠ¤ ë°˜ë‚©. ì •ë¦¬ ì‘ì—…
    }
}
throw new RetryFailedException(); // ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ë¥¼ ë„˜ê¸°ë©´ ì§ì ‘ ì˜ˆì™¸ ë°œìƒ
```

### ì˜ˆì™¸ì²˜ë¦¬ íšŒí”¼

ì˜ˆì™¸ ì²˜ë¦¬ í•¸ë“¤ë§ì„ clientì—ê²Œ ë– ë„˜ê¹€.

```java
public void add() throws SQLException {
// JDBC API
}
```

```java
public void add() throws SQLException {
try {
 // JDBC API
}
catch(SQLException e) {
	 	 // ë¡œê·¸ ì¶œë ¥
 throw e;
}
}
```

### ì˜ˆì™¸ ì „í™˜

ì˜ˆì™¸ íšŒí”¼ì™€ ë§ˆì°¬ê°€ì§€ë¡œ ì˜ˆì™¸ë¥¼ ë³µêµ¬í•  ìˆ˜ ì—†ì–´ì„œ ë°–ìœ¼ë¡œ ë˜ì§„ë‹¤. ëŒ€ì‹  ê·¸ëŒ€ë¡œ ë˜ì§€ëŠ”ê²Œ ì•„ë‹ˆê³  ì ì ˆí•œ ì˜ˆì™¸ë¡œ ì „í™˜í•´ì„œ ë˜ì§„ë‹¤. 

ë‘ ê°€ì§€ ì´ìœ ê°€ ìˆë‹¤. 

1. ë‚´ë¶€ì—ì„œ ë°œìƒí•œ ì˜ˆì™¸ë¥¼ ê·¸ëŒ€ë¡œ ë˜ì§€ëŠ” ê²ƒì´ ê·¸ ì˜ˆì™¸ ìƒí™©ì— ëŒ€í•œ ì ì ˆí•œ ì˜ë¯¸ë¥¼ ë¶€ì—¬í•´ì£¼ì§€ ëª»í•  ë•Œ, ì¢€ ë” ì˜ë¯¸ë¥¼ ë¶„ëª…íˆ í•  ì˜ˆì™¸ë¡œ ë°”ê¿”ì„œ ë˜ì§„ë‹¤. 
   Ex.
   ì‚¬ìš©ì ì•„ì´ë”” ë“±ë¡ì„ ì‹œë„í–ˆì„ ë–„ ì¤‘ë³µë˜ì„œ JDBC apiê°€ SQLExceptionì„ ë˜ì§€ë©´ ì•„ì´ë””ë¥¼ ë“±ë¡í•˜ë ¤ë˜ ì„œë¹„ìŠ¤ ê³„ì¸µ ë“±ì—ì„œëŠ” ì™œ  SQLExceptionì´ ìƒê²¼ëŠ”ì§€ ì•Œê¸¸ì´ ì—†ë‹¤. â¡DAOì—ì„œ DuplicateExceptionì˜ˆì™¸ë¡œ ë°”ê¿” ë˜ì ¸ì•¼ ì„œë¹„ìŠ¤ ê³„ì¸µì—ì„œ ì ì ˆí•œ ë³µêµ¬ë¥¼ ì‹œë„í•  ìˆ˜ ìˆë‹¤. 

   ```java
   public void add(User user) throws DuplicateUserIdException, SQLException {
       try {
                // JDBCë¥¼ ì´ìš©í•´ user ì •ë³´ë¥¼ DBì— ì¶”ê°€í•˜ëŠ” ì½”ë“œ ë˜ëŠ”
                // ê·¸ëŸ° ê¸°ëŠ¥ì„ ê°€ì§„ ë‹¤ë¥¸ SQLExceptionì„ ë˜ì§€ëŠ” ë©”ì†Œë“œë¥¼ í˜¸ì¶œí•˜ëŠ” ì½”ë“œ
       }
       catch(SQLException e) {
                // ErrorCodeê°€ MySQLì˜ "Duplicate Entry(1062)"ì´ë©´ ì˜ˆì™¸ ì „í™˜
        if (e.getErrorCode() = = MysqlErrorNumbers.ER_DUP_ENTRY) 
        throw DuplicateUserIdException();
        else 
        throw e; // ê·¸ ì™¸ì˜ ê²½ìš°ëŠ” SQLException ê·¸ëŒ€ë¡œ
       }
   }
   ```

   ğŸ˜ë³´í†µ ì „í™˜í•˜ëŠ” ì˜ˆì™¸ì— ì›ë˜ ë°œìƒí•œ ì˜ˆì™¸ë¥¼ ë‹´ì•„ì„œ nested Exceptionìœ¼ë¡œ ë§Œë“œëŠ”ê²Œ ì¢‹ë‹¤. getCause()ë¡œ ì²˜ìŒ ë°œìƒí•œ ì˜ˆì™¸ë¥¼ ì•Œ ìˆ˜ ìˆì–´ì„œë‹¤. 

   ```java
   catch(SQLException e) {
   ...
   throw DuplicateUserIdException(e);
   ```

2. ì˜ˆì™¸ë¥¼ êµ¬ì²´ì ìœ¼ë¡œ ë°”ê¾¸ë ¤ëŠ”ê²Œ ì•„ë‹Œ, check exceptionì„ unchecked exceptionìœ¼ë¡œ ë°”ê¾¸ë ¤ê³  í•  ë•Œ ì‚¬ìš©í•œë‹¤.

```java
catch(SQLException e) {
...
throw DuplicateUserIdException().initCause(e); 
//â¡ì´ ê²½ìš° ì˜ˆì™¸ë¥¼ êµ¬ì²´ì ìœ¼ë¡œ ë°”ê¾¸ë ¤ëŠ”ê²Œ ì•„ë‹Œ, check exceptionì„ unchecked exceptionìœ¼ë¡œ ë°”ê¾¸ë ¤ê³  í•  ë•Œ ì‚¬ìš©í•œë‹¤. 
// ì˜ˆë¥¼ë“¤ì–´, ì²´í¬ ì˜ˆì™¸ì¸ EJB component ì˜ˆì™¸ë“¤ì€ ì€ ì˜ë¯¸ìˆëŠ” ì˜ˆì™¸ë‚˜ ë³µêµ¬ê°€ëŠ¥í•œ ì˜ˆì™¸ê°€ ì•„ë‹ˆë‹¤. ê³ ë¡œ ëŸ°íƒ€ì„ ì˜ˆì™¸ì¸ EJBExceptionë¡œ í¬ì¥í•´ì„œ ë˜ì§„ë‹¤. 
try {
 OrderHome orderHome = EJBHomeFactory.getInstance().getOrderHome();
 Order order = orderHome.findByPrimaryKey(Integer id);
} catch (NamingException ne) {
 throw new EJBException(ne);
} catch (SQLException se) {
 throw new EJBException(se);
} catch (RemoteException re) {
 throw new EJBException(re);
}
    // EJBëŠ” ëŸ°íƒ€ì„ ì˜ˆì™¸ì—ì„œ, íŠ¸ëœì­ì…˜ì„ ìë™ìœ¼ë¡œ ë¡¤ë°±í•´ì¤€ë‹¤. 
```



## 1.4 ì˜ˆì™¸ì²˜ë¦¬ ì „ëµ

### ëŸ°íƒ€ì„ ì˜ˆì™¸ì˜ ë³´í¸í™”

ë³µêµ¬ê°€ëŠ¥í•œ ì˜ˆì™¸ê°€ ì•„ë‹ˆë©´ ì¼ë‹¨ ì–¸ì²´í¬ ì˜ˆì™¸ë¡œ ë§Œë“¤ì–´ë¼. 
### Add()ì˜ ì˜ˆì™¸ ì²˜ë¦¬

ì•„ì´ë””ê°€ ì¤‘ë³µë  ë•Œ ì‚¬ìš©í•  DuplicateExceptionì„ ëŸ°íƒ€ì„ ì˜ˆì™¸ë¡œ ë§Œë“¤ì. 
ì¤‘ì²© ì˜ˆì™¸ë¡œ ì“¸ ìˆ˜ ìˆê²Œ  ìƒì„±ì ì¶”ê°€ë„ í•´ì£¼ê³ 

```java
package com.example.tobby.user.dao;

public class DuplicateUserIdException extends RuntimeException {
    public DuplicateUserIdException(Throwable cause) {
        super(cause);
    }
}

```

```java
public void add() throws DuplicateUserIdException {
    try {
             // JDBCë¥¼ ì´ìš©í•´ user ì •ë³´ë¥¼ DBì— ì¶”ê°€í•˜ëŠ” ì½”ë“œ ë˜ëŠ”
             // ê·¸ëŸ° ê¸°ëŠ¥ì´ ìˆëŠ” ë‹¤ë¥¸ SQLExceptionì„ ë˜ì§€ëŠ” ë©”ì†Œë“œë¥¼ í˜¸ì¶œí•˜ëŠ” ì½”ë“œ
    }
    catch (SQLException e) {
     if (e.getErrorCode() = = MysqlErrorNumbers.ER_DUP_ENTRY) 
             throw new DuplicateUserIdException(e); 	 // ì˜ˆì™¸ ì „í™˜
     else
             throw new RuntimeException(e);	 	 // ì˜ˆì™¸ í¬ì¥
    }
}
```

ğŸ˜ëŸ°íƒ€ì„ ì˜ˆì™¸ë¥¼ ì“°ëŠ” ê²½ìš° ì»´íŒŒì¼ëŸ¬ê°€ ê°•ì œí•˜ì§€ ì•ŠëŠ” ë§Œí¼ ê°œë°œìê°€ ë” ì‹ ê²½ ì¨ì•¼ í•œë‹¤. 

### application ì˜ˆì™¸

ğŸ¤”ì§€ê¸ˆê¹Œì§€, ì¼ë‹¨ ë³µêµ¬ í•  ìˆ˜ ìˆëŠ” ì˜ˆì™¸ëŠ” ì—†ë‹¤ê³  ê°€ì •í•´ì„œ ì£„ë‹¤ ëŸ°íƒ€ì„ ì˜ˆì™¸ë¡œ ëŒë ¤ë²„ë¦¬ê³ , ì‹œìŠ¤í…œì´ ì•Œì•„ì„œ ì²˜ë¦¬í•´ì£¼ê¸¸ ê¸°ëŒ€í•˜ì§€ë§Œ êµ³ì´ í•„ìš”í•œ ê²½ìš°ëŠ” ëŸ°íƒ€ì„ ì˜ˆì™¸ë¼ë„ ì¡ì•„ì„œ ë³µêµ¬í•˜ê² ë‹¤ëŠ” íƒœë„ì˜€ë‹¤.
ğŸ˜ì‹œìŠ¤í…œ or ì™¸ë¶€ì—ì„œ ì˜ˆì™¸ê°€ ë°œìƒí•œê²Œ ì•„ë‹ˆë¼ application ìì²´ ë¡œì§ì— ì˜í•´ ë°œìƒí•´ë²„ë ¤ ë°˜ë“œì‹œ catchí•´ì¤˜ì•¼ í•˜ëŠ” ì˜ˆì™¸ë¥¼ application ì˜ˆì™¸ë¼ê³  í•œë‹¤. 

ì˜ˆë¥¼ ë“¤ì–´

ì‚¬ìš©ìê°€ ìš”ì²­í•œ ê¸ˆì•¡ì„ ì¶œê¸ˆí•˜ëŠ” ê¸°ëŠ¥ì„ ë§Œë“œëŠ”ë°,
í˜„ì¬ ì”ê³ ë¥¼ í™•ì¸í•´ì„œ ë²”ìœ„ë¥¼ ë„˜ì–´ì„œë©´ ì¶œê¸ˆì„ ì¤‘ë‹¨ì‹œí‚¨ í›„ ì ì ˆí•œ ê²½ê³ ë¥¼ ë³´ë‚´ì•¼ í•œë‹¤. ì„¤ê³„ ë°©ì‹ì€ ë‘ ê°€ì§€ê°€ ìˆë‹¤. 

1. ì •ìƒ ì¶œê¸ˆ ì²˜ë¦¬ì™€ ì”ê³  ë¶€ì¡±ì´ ë°œìƒí–ˆì„ ë•Œ ê°ê° ë‹¤ë¥¸ ì¢…ë¥˜ì˜ ë¦¬í„´ì„ ëŒë ¤ì¤€ë‹¤.

   * ì˜ˆì™¸ ìƒí™©ê³¼ ë¦¬í„´ ê°’ì„ ëª…í™•í•˜ê²Œ ì½”ë“œí™” í•˜ê³  ê´€ë¦¬í•˜ì§€ ì•Šìœ¼ë©´ í˜¼ë€ì´ ìƒê¸´ë‹¤. 
   * ifë¬¸ìœ¼ë¡œ ë²”ë²…

2. ì •ìƒì ì¸ íë¦„ì„ ë”°ë¥´ëŠ” ì½”ë“œëŠ” ê·¸ëŒ€ë¡œ ë‘ê³  ì˜ˆì™¸ ìƒí™©ì—ì„œëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ì˜ë¯¸ë¥¼ ê°€ì§„ ì˜ˆì™¸ë¥¼ ë˜ì§„ë‹¤. 

   * ì˜ë„ì ìœ¼ë¡œ ì²´í¬ ì˜ˆì™¸ë¡œ ë§Œë“ ë‹¤. 

   * ì˜ˆì™¸ ê°€ëŠ¥ì„±ì´ ìˆëŠ” ì½”ë“œëŠ” tryì— ëª¨ìœ¼ê³ , ë³µêµ¬ëŠ” catchì— ëª¨ì•„ë‘˜ ìˆ˜ ìˆë‹¤. 

     ```java
     try {
     BigDecimal balance = account.withdraw(amount);
     ...
     	 // ì •ìƒì ì¸ ì²˜ë¦¬ ê²°ê³¼ë¥¼ ì¶œë ¥í•˜ë„ë¡ ì§„í–‰
     }
     catch(InsufficientBalanceException e) {	 // ì²´í¬ ì˜ˆì™¸
     	 // InsufficientBalanceExceptionì— ë‹´ê¸´ ì¸ì¶œ ê°€ëŠ¥í•œ ì”ê³ ê¸ˆì•¡ ì •ë³´ë¥¼ ê°€ì ¸ì˜´
     BigDecimal availFunds = e.getAvailFunds();
     ...
     	 // ì”ê³  ë¶€ì¡± ì•ˆë‚´ ë©”ì‹œì§€ë¥¼ ì¤€ë¹„í•˜ê³  ì´ë¥¼ ì¶œë ¥í•˜ë„ë¡ ì§„í–‰
     }
     ```

### 1.5 SQLExceptionì€ ì–´ë–»ê²Œ ëë‚˜?

ê·¸ë˜ì„œ JDBCTemplateì€ throws SQLExceptionì´ ì™œ ì—†ë‚˜?
ì¼ë‹¨ SQLExceptionì€ ì½”ë“œ ë ˆë²¨ì—ì„œ ë³µêµ¬í•  ë°©ë²•ì´ ì—†ë‹¤. 
ì›ì¸ì´ ì£¼ë¡œ..

* SQL ë¬¸ë²• ì—ì„œ
* ì œì•½ ì¡°ê±´ ìœ„ë°˜
* DB  server down
* nw ë¶ˆì•ˆì •
* DB connection pool full

ê°€ëŠ¥í•œ ë¹¨ë¦¬ ëŸ°íƒ€ì„ ì˜ˆì™¸ë¡œ ì „í™˜í•´ì¤˜ë¼. ê·¸ë˜ì„œ JDBCTemplateì€ ì´ ì „ëµì„ ë”°ë¥´ê³  ìˆë‹¤. 

# 2. ì˜ˆì™¸ ì „í™˜

## 2.1 JDBC ì˜ í•œê³„

JDBCëŠ” DBê°€ ë°”ë€Œì–´ë„ ë™ì¼í•˜ê²Œ ê°œë°œí•  ìˆ˜ ìˆê²Œ ë˜ì—ˆì§€ë§Œ, ì´ë ‡ê²Œ DBì¢…ë¥˜ë¥¼ ì´ˆì›”í•œ ë°ì´í„° ì ‘ê·¼ ì½”ë“œë¥¼ ì‘ì„±í•˜ëŠ” ì¼ì€ ì–´ë µë‹¤. ì¦‰, DBë¥¼ ììœ ë¡­ê²Œ ë°”ê¾¸ê¸°ì—” JDBCê°€ í•´ê²°í•˜ì§€ ëª»í•˜ëŠ” ê±¸ë¦¼ëŒì´ ë‘ê°€ì§€ ìˆë‹¤. 

### ë¹„í‘œì¤€ SQL

íŠ¹ì • DBë§Œ ê°€ì§„ SQLì€ ê²°êµ­ DAOì½”ë“œì— ë“¤ì–´ê°€ê²Œ ë˜ê³ , DBì— ì¢…ì†ì ì¸ ì½”ë“œê°€ ë˜ë²„ë¦°ë‹¤. ê²°êµ­ DAOë¥¼ DBë³„ë¡œ ë§Œë“¤ì–´ ì‚¬ìš©í•˜ê±°ë‚˜, SQLì„ ì™¸ë¶€ì—ì„œ ë…ë¦½ì‹œì¼œ ë°”ê¿”ì“¸ ìˆ˜ ìˆê²Œ í•˜ëŠ” ìˆ˜ ë°–ì—..

### í˜¸í™˜ì„± ì—†ëŠ” SQLExceptionì˜ DB error

DBë§ˆë‹¤ ì—ëŸ¬ì˜ ì¢…ë¥˜ì™€ ì›ì¸ì´ ë‹¤ë¥´ë‹¤. ê³ ë¡œ JDBCëŠ” SQLExceptionìœ¼ë¡œ í‰ì¹œë‹¤..
getErrorCode()ë¡œ ì—ëŸ¬ ì½”ë“œë¥¼ ê¹Œì„œ ì›ì¸ì„ íŒŒì•…í•´ë³´ë ¤ í•´ë„  DBë³„ë¡œ ì—ëŸ¬ ì½”ë“œê°€ ë‹¤ë¥´ë‹¤. 

``` java
if (e.getErrorCode() = = MysqlErrorNumbers.ER_DUP_ENTRY) { ..
```

> SQLException ë§Œìœ¼ë¡œ DBì— ë…ë¦½ì ì¸ ìœ ì—°í•œ ì½”ë“œë¥¼ ì‘ì„±í•˜ëŠ” ê±´ ë¶ˆê°€ëŠ¥ì— ê°€ê¹ë‹¤.

## 2.2 DBì—ëŸ¬ ì½”ë“œ ë§¤í•‘ì„ í†µí•œ ì „í™˜

ìŠ¤í”„ë§ì€ DBë³„ ì—ëŸ¬ ì½”ë“œë¥¼ ì°¸ê³ í•´ì„œ ë°œìƒí•œ ì˜ˆì™¸ì˜ ì›ì¸ì´ ë¬´ì—‡ì¸ì§€ í•´ì„í•´ì¤€ë‹¤.

DBë³„ ì—ëŸ¬ ì½”ë“œ ë§¤í•‘ ì •ë³´ í…Œì´ë¸”ì„ ë§Œë“¤ì–´ë‘ê³  ì´ë¥¼ ì´ìš©í•œë‹¤. 

JdbcTemplateì€ SQLException ì„ ëŸ°íƒ€ì„ ì˜ˆì™¸ì¸ DataSourceExceptionì˜ ì„œë¸Œ í´ë˜ìŠ¤ë“¤ ì¤‘ ì ë‹¹í•œ ê²ƒìœ¼ë¡œ í¬ì¥í•´ì„œ ë˜ì§„ë‹¤. 

jdbcTemaplateì„ ì‚¬ìš©í•˜ëŠ” add()ë¥¼ ì‚¬ìš©í•˜ëŠ” ìª½ì—ì„œ ì¤‘ë³µ í‚¤ ìƒí™©ì— ëŒ€ì‘í•  ë•Œ ì°¸ê³ í•  ìˆ˜ ìˆë„ë¡  thorows DuplicateKeyExceptionì„ add()ì •ì˜ì— ì¶”ê°€í•˜ì. 

```java
    public void add(User user) throws DuplicateKeyException {
        this.jdbcTemplate.update("insert into users (id, name, password) values(?,?,?)", user.getId(), user.getName(), user.getPassword());
    }
```

ë§Œì•½ ì²´í¬ ì—ëŸ¬ë¡œ ë°”ê¾¸ê³  ì‹¶ìœ¼ë©´ ì´ë ‡ê²Œ í•˜ë©´ ë˜ì§€.

```java
public void add() throws DuplicateUserIdException {
    try {
             // jdbcTemplateì„ ì´ìš©í•´ Userë¥¼ add í•˜ëŠ” ì½”ë“œ
    }
    catch(DuplicateKeyException e) {
             // ë¡œê·¸ë¥¼ ë‚¨ê¸°ëŠ” ë“±ì˜ í•„ìš”í•œ ì‘ì—…
     throw new DuplicateUserIdException(e);
    }
}
```

 

## 2.3 DAOì¸í„°í˜ì´ìŠ¤ì™€ DataAccessExceptionê³„ì¸µ êµ¬ì¡°

 DataAccessExceptionì€ ìë°”ì˜ ë°ì´í„° ì ‘ê·¼ì˜ í‘œì¤€ ê¸°ìˆ (jdbc, jpa, jdo, iBatis, hibernate etc) ì—ì„œ ë°œìƒí•˜ëŠ”  SQLExceptionì„ ì „í™˜í•˜ëŠ” ìš©ë„ë¡œ ì‚¬ìš©ëœë‹¤. 
ë‹¨, ë°ì´í„° ì•¡ì„¸ìŠ¤ ê¸°ìˆ ì˜ ì¢…ë¥˜ì™€ ìƒê´€ì—†ì´ ì¶”ìƒí™”ëœ ì˜ˆì™¸ë¡œ ì œê³µí•œë‹¤. 

### DAOì¸í„°í˜ì´ìŠ¤ì™€ êµ¬í˜„ì˜ ë¶„ë¦¬

DAOëŠ” ì¸í„°í˜ì´ìŠ¤ë¥¼ ì‚¬ìš©í•´ ì „ëµ íŒ¨í„´ê³¼ DIë¡œ 
êµ¬ì²´ì ì¸ í´ë˜ìŠ¤ì˜ ì •ë³´ì™€ êµ¬í˜„ ë°©ë²•ì„ ê°ì¶”ê³ ,
DIë¥¼ í†µí•´ ì œê³µë˜ë„ë¡ ë§Œë“ ë‹¤.
í•˜ì§€ë§Œ,, ë©”ì†Œë“œ ì„ ì–¸ì— ë‚˜íƒ€ë‚˜ëŠ” ì˜ˆì™¸ëŠ” ìˆ¨ê¸¸ ìˆ˜ ì—†ë‹¤. 

```java
public void add(User user) throws SQLException; //jdbc api
public void add(User user) throws PersistentException; // JPA
public void add(User user) throws HibernateException; // Hibernate
public void add(User user) throws JdoException; // JDO
```

ê²°êµ­ ì¸í„°í˜ì´ìŠ¤ë¡œ ë©”ì†Œë“œì˜ êµ¬í˜„ì€ ì¶”ìƒí™” í–ˆì§€ë§Œ êµ¬í˜„ ê¸°ìˆ ë§ˆë‹¤ ë˜ì§€ëŠ” ì˜ˆì™¸ê°€ ë‹¤ë¥´ê¸°ì— ë©”ì†Œë“œì˜ ì„ ì–¸ì´ ë‹¬ë¼ì§„ë‹¤. ì¦‰ ë””ë¹„ì— ì¢…ì†ì ì´ë‹¤. 

ğŸ¤”ëª¨ë“  ì˜ˆì™¸ë¥¼ ë‹¤ ë°›ì•„ì£¼ëŠ” throws Exceptioní• ê¹Œ? ì•„ëƒ ë¬´ì±…ì„í•´..

ë‹¤í–‰íˆë„  JDO, Hibernate, JPAë“±ì€ SQLException ê°™ì€ ì²´í¬ ì˜ˆì™¸ ëŒ€ì‹  ëŸ°íƒ€ì„ ì˜ˆì™¸ë¥¼ ë˜ì ¸ì„œ throwsì„ ì–¸ì´ í•„ìš”ì—†ë‹¤. ë¬¼ë¡  SQLExceptionì„ ë˜ì§€ëŠ” Jdbc apiëŠ” ëŸ°íƒ€ì„ ì˜ˆì™¸ë¡œ í¬ì¥í•˜ë©´ ëœë‹¤. 

í•˜ì§€ë§Œ ì¶©ë¶„í•˜ì§€ ì•Šë‹¤. ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì—ì„œ ì˜ë¯¸ìˆê²Œ ì²˜ë¦¬í•˜ê±°ë‚˜, ì‹œìŠ¤í…œ ë ˆë²¨ì—ì„œ ì˜ë¯¸ìˆê²Œ ì˜ˆì™¸ë¥¼ ë¶„ë¥˜í•´ì•¼ í•˜ëŠ” ìƒí™©ì—ì„œëŠ” ë°ì´í„° ì ‘ê·¼ ê¸°ìˆ ì— ë”°ë¼ ë‹¤ë¥¸ ì˜ˆì™¸ê°€ ë˜ì ¸ì§€ëŠ” ê²ƒì´ ì—¬ì „íˆ í•´ê²°ë˜ì§€ ì•ŠëŠ”ë‹¤. 

### ë°ì´í„° ì•¡ì„¸ìŠ¤ ì˜ˆì™¸ ì¶”ìƒí™”ì™€ DataAccessExceptionê³„ì¸µ êµ¬ì¡°

ê·¸ë˜ì„œ ìŠ¤í”„ë§ì€ ìë°”ì˜ ë‹¤ì–‘í•œ ë°ì´í„° ì ‘ê·¼ ê¸°ìˆ ì„ ì‚¬ìš©í•  ë•Œ ë°œìƒí•˜ëŠ” ì˜ˆì™¸ë“¤ì„ ì¶”ìƒí™”í•´ì„œ DataAccessException ê³„ì¸µêµ¬ì¡° ì•ˆì— ì •ë¦¬í•´ë†“ì•˜ë‹¤. 

## 2.4 ê¸°ìˆ ì— ë…ë¦½ì ì¸ UserDaoë§Œë“¤ê¸°

### ì¸í„°í˜ì´ìŠ¤ ì ìš©

UserDaoë¥¼ ì¸í„°í˜ì´ìŠ¤ì™€ êµ¬í˜„ìœ¼ë¡œ ë¶„ë¦¬í•´ë³´ì. 

```java
package com.example.tobby.user.dao;

import com.example.tobby.user.domain.User;

import java.util.List;

public interface UserDao {
    void add(User user);

    User get(String id);

    List<User> getAll();

    void deleteAll();

    int getCount();
}

```

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd">
    <bean id="connectionMaker" class="com.example.tobby.user.dao.DConnectionMaker"/>
    <bean id="userDao" class="com.example.tobby.user.dao.UserDaoJdbc">
        <property name="dataSource" ref="dataSource"/>
    </bean>
    <bean id="dataSource" class="org.springframework.jdbc.datasource.SimpleDriverDataSource">
        <property name="driverClass" value="com.mysql.cj.jdbc.Driver"/>
        <property name="url" value="jdbc:mysql://localhost/tobby"/>
        <property name="username" value="tobaby"/>
        <property name="password" value="0000"/>
    </bean>
</beans>
```

ë³´í†µ ë¹ˆì˜ ì´ë¦„ì€ í´ë˜ìŠ¤ ì´ë¦„ì´ ì•„ë‹ˆë¼,  dataSource ë¹ˆì´ ê·¸ë¬ë˜ ê²ƒì²˜ëŸ¼ í´ë˜ìŠ¤ì˜ êµ¬í˜„ ì¸í„°í˜ì´ìŠ¤ ì´ë¦„ì„ ë”°ë¥´ëŠ” ê²½ìš°ê°€ ì¼ë°˜ ì ì´ë‹¤. 

```java
package com.example.tobby.user.dao;

import com.example.tobby.user.domain.User;
import org.springframework.jdbc.datasource.SimpleDriverDataSource;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.SQLException;
import java.util.List;

public class UserDaoJdbc implements UserDao {

    @Override
    public void add(User user) {

    }

    @Override
    public User get(String id) {
        return null;
    }

    @Override
    public List<User> getAll() {
        return null;
    }

    @Override
    public void deleteAll() {

    }

    @Override
    public int getCount() {
        return 0;
    }

    public void setDataSource(SimpleDriverDataSource dataSource) {
    }
}

```

### í…ŒìŠ¤íŠ¸ ë³´ì™„

UserDaoTestì— ì¤‘ë³µëœ í‚¤ë¥¼ ê°€ì§„ ì •ë³´ë¥¼ ë“±ë¡í–ˆì„ ë•Œ ì–´ë–¤ ì˜ˆì™¸ê°€ ë°œìƒí•˜ëŠ”ì§€ë¥¼ í™• ì¸í•˜ê¸° ìœ„í•´ í…ŒìŠ¤íŠ¸ë¥¼ í•˜ë‚˜ ì¶”ê°€í•´ë³´ì

```java
    @Test
    public void duplicateKey() {
        assertThrows(DataAccessException.class, () -> {
            dao.deleteAll();
            dao.add(user1);
            dao.add(user1);
        });
    }
```

ìŠ¤ë¬´ìŠ¤í•˜ê²Œ í†µê³¼ë˜ëŠ”ë° êµ¬ì²´ì ìœ¼ë¡œ ì–´ë–¤ ì˜ˆì™¸ì¸ì§€ ê¶ê¸ˆí•˜ë‹ˆê¹Œ assertThrowsë¥¼ ì ì‹œ ì£¼ì„ì²˜ë¦¬í•˜ë‹ˆ ë±‰ëŠ” ì—ëŸ¬ê°€ ë§í•˜ê¸°ë¥¼ DuplicateKeyExceptionì´ë¼ê³  í•œë‹¤. 

```java
    @Test
    public void duplicateKey() {
        assertThrows(DuplicateKeyException.class, () -> {
            dao.deleteAll();
            dao.add(user1);
            dao.add(user1);
        });
    }
```

### DataAccessException í™œìš©ì‹œ ì£¼ì˜ì‚¬í•­

ì˜ˆì™¸ ì½”ë“œë¥¼ ë³´ê³  DuplicateKeyException ì„ ë˜ì§€ëŠ” JDBCì™€ ë‹¬ë¦¬ hibernateë‚˜ jpaëŠ” ê°ìê°€ ì •ì˜í•œ ì˜ˆì™¸ë¥¼ ë˜ì§€ê¸° ë•Œë¬¸ì— ì¶”ìƒí™”ëœ ê³µí†µ ì˜ˆì™¸ë¡œ ì •ì˜í•  ë•Œ ì‹¤ì œë¡œ ì „í™˜ë˜ëŠ” ì˜ˆì™¸ì˜ ì¢…ë¥˜ë¥¼ ì²´í¬í•´ë†”ì•¼ í•œë‹¤. 

ìŠ¤í”„ë§ì€  SQLExceptionì„ í•´ì„í•´ DataAccessExceptionìœ¼ë¡œ ë³€í™˜í•˜ëŠ” ë‹¤ì–‘í•œ ë°©ë²•ì„ ì œê³µí•˜ëŠ”ë°
ì œì¼ í”í•œê²Œ DBì—ëŸ¬ ì½”ë“œë¥¼ ì´ìš©í•˜ëŠ” ê²ƒì´ë‹¤. SQLExceptionTranslatorì˜ êµ¬í˜„ì²´ ì¤‘, SQLErrorCodeSQLExceptionTranslatorë¥¼ ì“°ë©´ ëœë‹¤. 

``` java
  @Autowired
    DataSource dataSource;

    @Test
    public void sqlExceptionTranslate() {
        dao.deleteAll();
        try {
            dao.add(user1);
            dao.add(user1);
        } catch (DuplicateKeyException e) {
            SQLException sqlEx = (SQLException)e.getRootCause();
            SQLExceptionTranslator set =
                    new SQLErrorCodeSQLExceptionTranslator(this.dataSource);
            assertThat(set.translate(null, null, sqlEx)).isInstanceOf(DuplicateKeyException.class);
        }
    }
```

